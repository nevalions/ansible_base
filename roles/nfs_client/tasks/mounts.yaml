---
- name: Include items in fstab error
  ansible.builtin.include_tasks: common/tasks/check_nfs_item_in_fstab_deleted.yaml
  vars:
    folders_list: "{{ nfs_mounts }}"

- name: Mount NFS shares temporarily
  ansible.posix.mount:
    path: "{{ item.mount_point }}"
    src: "{{ item.server }}:{{ item.path }}"
    fstype: nfs
    opts: "{{ item.options }}"
    state: mounted
  loop: "{{ nfs_mounts }}"
  when: not item.fstab | default(false)

- name: Add NFS shares to fstab
  ansible.posix.mount:
    path: "{{ item.mount_point }}"
    src: "{{ item.server }}:{{ item.path }}"
    fstype: nfs
    opts: "{{ item.options }}"
    state: present
  loop: "{{ nfs_mounts }}"
  when: item.fstab | default(false)

- name: Include items in fstab
  ansible.builtin.include_tasks: common/tasks/check_nfs_item_in_fstab_exist.yaml
  vars:
    folders_list: "{{ nfs_mounts }}"

- name: Mount all filesystems (for fstab entries)
  ansible.builtin.command: mount -a
  when: nfs_mounts | selectattr('fstab', 'defined') | selectattr('fstab') | list | length > 0

- name: Verify NFS mounts are active
  ansible.builtin.command: findmnt -n -o SOURCE,TARGET "{{ item.mount_point }}"
  register: mount_verify
  loop: "{{ nfs_mounts }}"
  changed_when: false
  ignore_errors: true

- name: Fail if any mount failed
  ansible.builtin.fail:
    msg: "ERROR: NFS mount failed for {{ item.item.server }}:{{ item.item.path }} at {{ item.item.mount_point }}"
  when:
    - item.rc != 0
    - item.stdout == ''
  loop: "{{ mount_verify.results }}"
  run_once: true
