---
skip_folder_check: true

dns_operation: "install"
dns_nameservers: "{{ [vault_dns_server_primary, vault_dns_server_secondary] | select('defined') | select('ne', '') | list }}"
dns_search_domains: "{{ [vault_dns_zone] | select('defined') | select('ne', '') | list }}"
dns_options: "{{ vault_dns_client_options | default(['timeout:2', 'attempts:3', 'rotate']) }}"
dns_test_host: "google.com"

# ── CoreDNS / WireGuard DNS reliability note ──────────────────────────────────
# CoreDNS runs with dnsPolicy: Default, so it inherits the node's /etc/resolv.conf
# as its upstream resolver. This means the full DNS chain for every pod is:
#
#   Pod → CoreDNS → node resolv.conf → dnsmasq (wg99 IP) → Unbound DNS servers
#
# Two failure modes affect nodes on different network segments (e.g. vas-worker1
# on 9.11.0.x vs bay-* nodes):
#
# 1. AAAA-first timeout: if upstream returns AAAA records but the node has no IPv6
#    egress, clients (containerd, ACME, GitHub Actions runners) try IPv6 first,
#    time out, and only then fall back to IPv4. This can burn 30-90 s per attempt.
#    Fix: enable dns_client_filter_aaaa to drop AAAA at the dnsmasq layer.
#
# 2. Primary-only pinning with no fallback: domains in dns_client_dnsmasq_primary_only_domains
#    are routed exclusively to vault_dns_server_primary. If that path is unreliable
#    for a specific node (different WG path, rate limiting, etc.) there is zero
#    fallback and the query returns SERVFAIL immediately.
#    Fix: remove latency-sensitive CI domains (githubusercontent.com, ghcr.io, etc.)
#    from the primary-only list so dnsmasq can round-robin across all upstreams.
#
# IMPORTANT: Do NOT bind dnsmasq to 127.0.0.1 — CoreDNS pods would forward to
# themselves. Bind to the node's wg99 IP and set /etc/resolv.conf to that address.
# ──────────────────────────────────────────────────────────────────────────────

# Enable node-local DNS forwarder (dnsmasq) with AAAA filtering.
# Auto-enabled for all kuber_small_all / planes_all / workers_all members.
# Override via vault_dns_client_node_local_enabled if needed.
dns_client_node_local_enabled: >-
  {{
    vault_dns_client_node_local_enabled
    | default(
        inventory_hostname in (
          (groups.get('kuber_small_all', [])
           + groups.get('kuber_small_all_with_services', [])
           + groups.get('planes_all', [])
           + groups.get('workers_all', []))
        ),
        true
      )
  }}

# WireGuard interface name to bind dnsmasq on (node IP is derived from facts)
dns_client_node_local_interface: "{{ vault_wg_interface | default('wg99') }}"

# Filter AAAA responses (forces IPv4-only upstream resolution).
# Recommended: true for any node without working IPv6 egress — eliminates the
# AAAA-first timeout that causes 30-90 s delays in containerd / ACME / runners.
# Enable via vault_dns_client_filter_aaaa: true in vault_secrets.yml.
# For WireGuard-client nodes on separate subnets (e.g. vas-worker1 on 9.11.0.x)
# this should be true because IPv6 is disabled in Unbound and on the cluster.
dns_client_filter_aaaa: "{{ vault_dns_client_filter_aaaa | default(false) }}"

# Binding mode for dnsmasq listener.
# bind-dynamic tolerates interfaces/addresses appearing after service start.
dns_client_dnsmasq_bind_mode: "bind-dynamic"

# Upstream query behavior for node-local dnsmasq.
# Keep strict-order disabled so dnsmasq can failover to a healthy upstream when
# the primary returns an error or times out.
dns_client_dnsmasq_strict_order: false

# dnsmasq config path managed by this role
dns_client_dnsmasq_config_path: "/etc/dnsmasq.d/99-k8s-filter-aaaa.conf"

# Domains pinned exclusively to the primary upstream.
# Use this list only for domains where the secondary resolver is known to be
# rate-limited or unreliable (e.g. Google/AWS CDN infrastructure behind the
# secondary BGP resolver).
#
# IMPORTANT: Do NOT include CI/CD domains (githubusercontent.com, ghcr.io, etc.)
# here. Pinning them to a single upstream with no fallback means a brief WireGuard
# path degradation or primary Unbound hiccup causes SERVFAIL for every GitHub
# Actions job — the root cause of the 100-second OAuth timeout chain on vas-worker1.
# Those domains are now handled by dns_client_dnsmasq_ci_domains (round-robin over
# all upstreams) so dnsmasq can use a healthy upstream automatically.
#
# Override via vault_dns_client_primary_only_domains if your secondary resolver
# handles these domains reliably.
dns_client_dnsmasq_primary_only_domains: >-
  {{
    vault_dns_client_primary_only_domains | default([
      'pkg.dev',
      'googleusercontent.com',
      'amazonaws.com',
      'registry.k8s.io'
    ])
  }}

# CI/CD and container registry domains that must never be stuck behind a single
# upstream. dnsmasq will round-robin across ALL configured upstreams for these,
# automatically retrying on the other resolver if one is slow or returns SERVFAIL.
# Override via vault_dns_client_ci_domains to customise or extend the list.
dns_client_dnsmasq_ci_domains: >-
  {{
    vault_dns_client_ci_domains | default([
      'githubusercontent.com',
      'github.com',
      'github.io',
      'ghcr.io',
      'actions.githubusercontent.com',
      'docker.io',
      'docker.com',
      'quay.io',
      'gcr.io'
    ])
  }}
