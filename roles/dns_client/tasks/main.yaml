---
- name: Check DNS client configuration status
  ansible.builtin.stat:
    path: /etc/resolv.conf
  register: resolv_conf_stat

- name: Compute DNS client effective settings
  ansible.builtin.set_fact:
    dns_client_upstream_nameservers: "{{ dns_nameservers }}"
    dns_client_node_local_listen_ip: >-
      {{
        ansible_facts.get(dns_client_node_local_interface, {})
        .get('ipv4', {})
        .get('address', '')
      }}
    dns_client_node_local_effective: >-
      {{
        (dns_client_node_local_enabled | default(false) | bool)
        and (dns_client_node_local_interface | default('') | length > 0)
      }}

- name: Validate node-local DNS prerequisites
  ansible.builtin.assert:
    that:
      - dns_client_node_local_listen_ip is defined
      - dns_client_node_local_listen_ip | length > 0
      - dns_client_upstream_nameservers is defined
      - dns_client_upstream_nameservers | length > 0
    fail_msg: >-
      Node-local DNS is enabled but prerequisites are missing.
      Ensure the WireGuard interface {{ dns_client_node_local_interface }} exists and
      vault_dns_server_primary/vault_dns_server_secondary are set.
  when:
    - dns_operation == "install"
    - ansible_facts['os_family'] == 'Debian'
    - dns_client_node_local_effective | bool

- name: Build dnsmasq upstream list (exclude self)
  ansible.builtin.set_fact:
    dns_client_dnsmasq_upstreams: >-
      {{
        dns_client_upstream_nameservers
        | reject('equalto', dns_client_node_local_listen_ip)
        | list
      }}
    dns_nameservers: "{{ [dns_client_node_local_listen_ip] }}"
  when:
    - dns_operation == "install"
    - ansible_facts['os_family'] == 'Debian'
    - dns_client_node_local_effective | bool

- name: Install dnsmasq (node-local DNS forwarder)
  ansible.builtin.apt:
    name: dnsmasq
    state: present
    update_cache: false
  when:
    - dns_operation == "install"
    - ansible_facts['os_family'] == 'Debian'
    - dns_client_node_local_effective | bool

- name: Deploy dnsmasq config (AAAA filtering)
  ansible.builtin.template:
    src: dnsmasq-k8s-filter-aaaa.conf.j2
    dest: "{{ dns_client_dnsmasq_config_path }}"
    mode: "0644"
    backup: true
  when:
    - dns_operation == "install"
    - ansible_facts['os_family'] == 'Debian'
    - dns_client_node_local_effective | bool
  notify: Restart dnsmasq

- name: Apply dnsmasq config immediately
  ansible.builtin.meta: flush_handlers
  when:
    - dns_operation == "install"
    - ansible_facts['os_family'] == 'Debian'
    - dns_client_node_local_effective | bool

- name: Ensure dnsmasq is enabled and started
  ansible.builtin.systemd:
    name: dnsmasq
    state: started
    enabled: true
  when:
    - dns_operation == "install"
    - ansible_facts['os_family'] == 'Debian'
    - dns_client_node_local_effective | bool

- name: Display DNS client management start
  ansible.builtin.debug:
    msg:
      - "=== DNS Client Management Start ==="
      - "Operation: {{ dns_operation }}"
      - "DNS servers: {{ dns_nameservers }}"
      - "Search domains: {{ dns_search_domains | default([]) | length }}"
      - "Current resolv.conf: {{ 'Ansible managed' if 'ANSIBLE MANAGED' in resolv_conf_stat.stat.exists | ternary(lookup('file', '/etc/resolv.conf', errors='ignore'), '') | default('') else 'Unknown' }}"

- name: Backup original resolv.conf before changes
  ansible.builtin.copy:
    src: /etc/resolv.conf
    dest: /etc/resolv.conf.original
    remote_src: yes
    mode: '0644'
  when:
    - dns_operation == "install"
    - resolv_conf_stat.stat.exists | bool
  ignore_errors: true

- name: Stop and disable systemd-resolved
  ansible.builtin.systemd:
    name: systemd-resolved
    state: stopped
    enabled: false
  when:
    - dns_operation == "install"
    - ansible_facts['os_family'] == 'Debian'

- name: Remove systemd-resolved stub resolv.conf
  ansible.builtin.file:
    path: /etc/resolv.conf
    state: absent
  when:
    - dns_operation == "install"
    - ansible_facts['os_family'] == 'Debian'
    - resolv_conf_stat.stat.exists | bool

- name: Deploy resolv.conf with custom DNS servers
  ansible.builtin.template:
    src: resolv.conf.j2
    dest: /etc/resolv.conf
    mode: '0644'
    backup: yes
  when: dns_operation == "install"

- name: Test DNS resolution
  ansible.builtin.command: "nslookup {{ dns_test_host | default('google.com') }} {{ dns_nameservers[0] }}"
  register: dns_test
  changed_when: false
  failed_when: false
  when:
    - dns_operation == "install"
    - dns_nameservers | length > 0

- name: Display DNS test result
  ansible.builtin.debug:
    msg:
      - "DNS resolution test for {{ dns_test_host | default('google.com') }}"
      - "Result: {{ 'SUCCESS' if dns_test.rc == 0 else 'FAILED' }}"
      - "Output: {{ dns_test.stdout_lines if dns_test.stdout_lines else ['No output'] }}"
  when:
    - dns_operation == "install"
    - dns_nameservers | length > 0

- name: Assert DNS is working
  ansible.builtin.assert:
    that:
      - dns_test.rc == 0
    success_msg: "DNS resolution is working correctly"
    fail_msg: "DNS resolution failed - check network connectivity and DNS server availability"
  when:
    - dns_operation == "install"
    - dns_nameservers | length > 0
    - not ansible_check_mode

- name: Display DNS client management completion
  ansible.builtin.debug:
    msg:
      - "=== DNS Client Management Complete ==="
      - "Operation: {{ dns_operation }}"
      - "DNS servers configured: {{ dns_nameservers | length }}"
      - "resolv.conf: /etc/resolv.conf (Ansible managed)"
  when: dns_operation == "install"
