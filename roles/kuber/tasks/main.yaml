---
- name: Check if Kubernetes cluster is already initialized
  ansible.builtin.stat:
    path: /etc/kubernetes/admin.conf
  register: k8s_cluster_initialized

- name: Check if Kubernetes binaries exist
  ansible.builtin.command: kubectl version --client
  register: kubectl_check
  changed_when: false
  failed_when: false

- name: Fail if Kubernetes cluster is already initialized
  ansible.builtin.fail:
    msg: "Kubernetes cluster is already initialized. If you want to reinstall, run kuber_plane_reset.yaml or kuber_worker_reset.yaml first."
  when: k8s_cluster_initialized.stat.exists

- name: Display Kubernetes installation start
  ansible.builtin.debug:
    msg:
      - "=== Kubernetes Installation Start ==="
      - "Kubernetes cluster: {{ 'Initialized' if k8s_cluster_initialized.stat.exists else 'Not initialized' }}"
      - "Kubernetes binaries: {{ 'Installed' if kubectl_check.rc == 0 else 'Not installed' }}"
      - "Proceeding with installation..."

- name: Display pre-flight validation start
  ansible.builtin.debug:
    msg:
      - "=== Pre-flight Validation Start ==="
      - "Running system checks before installation..."

- name: Check swap status
  ansible.builtin.command: swapon --show
  register: preflight_swap
  changed_when: false
  failed_when: false

- name: Warn about swap enabled
  ansible.builtin.debug:
    msg:
      - "⚠️ WARNING: Swap is enabled"
      - "Swap must be disabled for Kubernetes to work properly"
      - "Swap will be disabled during installation"
  when: preflight_swap.rc == 0 and not k8s_preflight_skip_swap_check

- name: Check if Docker is installed
  ansible.builtin.command: dpkg -l | grep docker-engine
  register: preflight_docker
  changed_when: false
  failed_when: false

- name: Fail if Docker is installed
  ansible.builtin.fail:
    msg:
      - "❌ CRITICAL: Docker is installed on this system"
      - "Docker conflicts with containerd (Kubernetes container runtime)"
      - "Please remove Docker before installing Kubernetes:"
      - "  sudo apt-get remove docker docker-engine docker.io containerd runc"
      - "  sudo apt-get purge -y docker-ce docker-ce-cli containerd.io"
      - "To skip this check, set vault_k8s_preflight_skip_docker_check: true"
  when: preflight_docker.rc == 0 and not k8s_preflight_skip_docker_check

- name: Check if Docker daemon is running
  ansible.builtin.systemd:
    name: docker
  register: preflight_docker_service
  failed_when: false

- name: Fail if Docker daemon is running
  ansible.builtin.fail:
    msg:
      - "❌ CRITICAL: Docker daemon is running"
      - "Docker conflicts with containerd (Kubernetes container runtime)"
      - "Please stop and disable Docker:"
      - "  sudo systemctl stop docker"
      - "  sudo systemctl disable docker"
      - "To skip this check, set vault_k8s_preflight_skip_docker_check: true"
  when: preflight_docker_service.status is defined and preflight_docker_service.status.ActiveState == 'active' and not k8s_preflight_skip_docker_check

- name: Check for conflicting container runtimes
  ansible.builtin.command: "pgrep -x '{{ item }}'"
  register: preflight_runtimes
  changed_when: false
  failed_when: false
  loop: "{{ k8s_preflight_conflicting_runtimes }}"
  when: not k8s_preflight_skip_container_runtime_check

- name: Fail if conflicting container runtime is running
  ansible.builtin.fail:
    msg:
      - "❌ CRITICAL: Conflicting container runtime detected: {{ item.item }}"
      - "Running process: {{ item.stdout_lines | default([]) }}"
      - "Kubernetes requires containerd as the container runtime"
      - "Please stop the conflicting runtime before installation"
      - "To skip this check, set vault_k8s_preflight_skip_container_runtime_check: true"
  when: item.rc == 0 and not k8s_preflight_skip_container_runtime_check
  loop: "{{ preflight_runtimes.results }}"

- name: Check if ports are in use
  ansible.builtin.command: "ss -tlnp | grep -E ':({{ k8s_preflight_check_ports | join('|') }})'"
  register: preflight_ports
  changed_when: false
  failed_when: false
  when: not k8s_preflight_skip_port_check

- name: Warn about ports in use
  ansible.builtin.debug:
    msg:
      - "⚠️ WARNING: The following ports are already in use:"
      - "{{ preflight_ports.stdout_lines }}"
      - "These ports are required by Kubernetes:"
      - "  API Server: {{ vault_k8s_api_port | default('[k8s-api-port]') }}"
      - "  HAProxy Frontend: {{ vault_haproxy_k8s_frontend_port | default('[haproxy-frontend-port]') }}"
      - "  Etcd: 2379, 2380"
      - "  Kubelet: 10250, 10255"
      - "  Scheduler: 10251"
      - "  Controller Manager: 10252"
      - "Please stop the conflicting services or release these ports"
      - "To skip this check, set vault_k8s_preflight_skip_port_check: true"
  when: preflight_ports.rc == 0 and not k8s_preflight_skip_port_check

- name: Fail if ports are in use
  ansible.builtin.fail:
    msg: "Ports in use. See warnings above."
  when: preflight_ports.rc == 0 and k8s_preflight_fail_on_warnings and not k8s_preflight_skip_port_check

- name: Check for existing CNI plugins
  ansible.builtin.stat:
    path: "{{ item }}"
  register: preflight_cni
  loop: "{{ k8s_preflight_cni_paths }}"
  when: not k8s_preflight_skip_cni_check

- name: Warn about existing CNI configuration
  ansible.builtin.debug:
    msg:
      - "⚠️ WARNING: Existing CNI configuration found: {{ item.item }}"
      - "Existing CNI plugins may conflict with Calico"
      - "These will be cleaned up during installation"
      - "To skip this check, set vault_k8s_preflight_skip_cni_check: true"
  when: item.stat.exists and not k8s_preflight_skip_cni_check
  loop: "{{ preflight_cni.results }}"

- name: Check for existing Kubernetes processes
  ansible.builtin.command: "pgrep -f '{{ item }}'"
  register: preflight_k8s_procs
  changed_when: false
  failed_when: false
  loop: "{{ k8s_preflight_k8s_processes }}"
  when: not k8s_preflight_skip_process_check

- name: Warn about existing Kubernetes processes
  ansible.builtin.debug:
    msg:
      - "⚠️ WARNING: Existing Kubernetes process found: {{ item.item }}"
      - "Process IDs: {{ item.stdout_lines | default([]) }}"
      - "This may indicate a previous installation"
      - "Please use kuber_plane_reset.yaml or kuber_worker_reset.yaml to clean up"
      - "To skip this check, set vault_k8s_preflight_skip_process_check: true"
  when: item.rc == 0 and not k8s_preflight_skip_process_check
  loop: "{{ preflight_k8s_procs.results }}"

- name: Fail if Kubernetes processes are running
  ansible.builtin.fail:
    msg: "Kubernetes processes are running. Please run kuber_plane_reset.yaml or kuber_worker_reset.yaml first."
  when: item.rc == 0 and k8s_preflight_fail_on_warnings and not k8s_preflight_skip_process_check
  loop: "{{ preflight_k8s_procs.results }}"

- name: Check kernel modules
  ansible.builtin.shell: |
    lsmod | grep -E "^(overlay|br_netfilter)"
  register: preflight_modules
  changed_when: false
  failed_when: false

- name: Warn if required kernel modules not loaded
  ansible.builtin.debug:
    msg:
      - "⚠️ WARNING: Required kernel modules not loaded:"
      - "{{ preflight_modules.stdout }}"
      - "These modules will be loaded during installation"
  when: preflight_modules.rc != 0

- name: Display pre-flight validation complete
  ansible.builtin.debug:
    msg:
      - "=== Pre-flight Validation Complete ==="
      - "All checks passed (see warnings above)"
      - "Proceeding with installation..."

- name: Ensure required packages are installed
  ansible.builtin.apt:
    name:
      - curl
      - ca-certificates
    state: present
    update_cache: true

- name: Install base CNI plugin package on Debian
  ansible.builtin.apt:
    name: containernetworking-plugins
    state: present
  when: ansible_os_family == 'Debian'

- name: Ensure CNI plugin directory exists
  ansible.builtin.file:
    path: /opt/cni/bin
    state: directory
    mode: "0755"

- name: Discover base CNI plugin binaries
  ansible.builtin.find:
    paths: /usr/lib/cni
    file_type: file
  register: kuber_base_cni_plugins
  when: ansible_os_family == 'Debian'

- name: Copy base CNI plugins to runtime directory
  ansible.builtin.copy:
    src: "{{ item.path }}"
    dest: "/opt/cni/bin/{{ item.path | basename }}"
    mode: "0755"
    remote_src: true
  loop: "{{ kuber_base_cni_plugins.files | default([]) }}"
  when: ansible_os_family == 'Debian'

- name: Verify loopback CNI plugin exists
  ansible.builtin.stat:
    path: /opt/cni/bin/loopback
  register: kuber_loopback_plugin

- name: Assert loopback CNI plugin is present
  ansible.builtin.assert:
    that:
      - kuber_loopback_plugin.stat.exists
    fail_msg: "CNI loopback plugin missing at /opt/cni/bin/loopback; pod sandbox creation will fail."
    success_msg: "CNI loopback plugin is present"

- name: Check installed Kubernetes version
  ansible.builtin.slurp:
    src: /opt/kubernetes_version
  register: installed_k8s_version
  failed_when: false

- name: Check if crictl exists
  ansible.builtin.stat:
    path: /usr/local/bin/crictl
  register: crictl_exists

- name: Determine if binaries need to be installed
  ansible.builtin.set_fact:
    k8s_binaries_need_install: "{{ installed_k8s_version.content is not defined or (installed_k8s_version.content | b64decode | trim) != 'v' + kubernetes_version + '.0' or not crictl_exists.stat.exists }}"

- name: Display binary installation decision
  ansible.builtin.debug:
    msg:
      - "Installed version: {{ (installed_k8s_version.content | b64decode | trim) if installed_k8s_version.content is defined else 'Not installed' }}"
      - "Target version: v{{ kubernetes_version }}.0"
      - "Will install binaries: {{ k8s_binaries_need_install }}"

- name: Create temporary directory for downloads
  ansible.builtin.tempfile:
    state: directory
    suffix: _k8s_install
  register: k8s_temp_dir
  when: k8s_binaries_need_install

- name: Download kubelet binary
  ansible.builtin.get_url:
    url: "https://dl.k8s.io/release/v{{ kubernetes_version }}.0/bin/linux/amd64/kubelet"
    dest: "{{ k8s_temp_dir.path }}/kubelet"
    mode: "0755"
    timeout: 300
  when: k8s_binaries_need_install

- name: Download kubectl binary
  ansible.builtin.get_url:
    url: "https://dl.k8s.io/release/v{{ kubernetes_version }}.0/bin/linux/amd64/kubectl"
    dest: "{{ k8s_temp_dir.path }}/kubectl"
    mode: "0755"
    timeout: 300
  when: k8s_binaries_need_install

- name: Download kubeadm binary
  ansible.builtin.get_url:
    url: "https://dl.k8s.io/release/v{{ kubernetes_version }}.0/bin/linux/amd64/kubeadm"
    dest: "{{ k8s_temp_dir.path }}/kubeadm"
    mode: "0755"
    timeout: 300
  when: k8s_binaries_need_install

- name: Download crictl binary archive
  ansible.builtin.get_url:
    url: "https://github.com/kubernetes-sigs/cri-tools/releases/download/v{{ crictl_version }}/crictl-v{{ crictl_version }}-linux-amd64.tar.gz"
    dest: "{{ k8s_temp_dir.path }}/crictl.tar.gz"
    mode: "0644"
    timeout: 300
  when: k8s_binaries_need_install

- name: Extract crictl binary
  ansible.builtin.unarchive:
    src: "{{ k8s_temp_dir.path }}/crictl.tar.gz"
    dest: "{{ k8s_temp_dir.path }}"
    remote_src: true
  when: k8s_binaries_need_install

- name: Create version file to track installed version
  ansible.builtin.copy:
    content: "v{{ kubernetes_version }}.0\n"
    dest: /opt/kubernetes_version
    mode: "0644"
  when: k8s_binaries_need_install

- name: Copy kubelet to /usr/local/bin
  ansible.builtin.copy:
    src: "{{ k8s_temp_dir.path }}/kubelet"
    dest: /usr/local/bin/kubelet
    mode: "0755"
    remote_src: true
  when: k8s_binaries_need_install

- name: Copy kubectl to /usr/local/bin
  ansible.builtin.copy:
    src: "{{ k8s_temp_dir.path }}/kubectl"
    dest: /usr/local/bin/kubectl
    mode: "0755"
    remote_src: true
  when: k8s_binaries_need_install

- name: Copy kubeadm to /usr/local/bin
  ansible.builtin.copy:
    src: "{{ k8s_temp_dir.path }}/kubeadm"
    dest: /usr/local/bin/kubeadm
    mode: "0755"
    remote_src: true
  when: k8s_binaries_need_install

- name: Copy crictl to /usr/local/bin
  ansible.builtin.copy:
    src: "{{ k8s_temp_dir.path }}/crictl"
    dest: /usr/local/bin/crictl
    mode: "0755"
    remote_src: true
  when: k8s_binaries_need_install

- name: Create symbolic links for backward compatibility
  ansible.builtin.file:
    src: "/usr/local/bin/{{ item }}"
    dest: "/usr/bin/{{ item }}"
    state: link
  loop:
    - kubelet
    - kubectl
    - kubeadm
    - crictl

- name: Create kubelet systemd service file
  ansible.builtin.copy:
    content: |
      [Unit]
      Description=kubelet: The Kubernetes Node Agent
      Documentation=https://kubernetes.io/docs/
      After=containerd.service
      Requires=containerd.service

      [Service]
      ExecStart=/usr/local/bin/kubelet
      Restart=always
      StartLimitInterval=0
      RestartSec=10

      [Install]
      WantedBy=multi-user.target
    dest: /etc/systemd/system/kubelet.service
    mode: "0644"

- name: Create kubelet drop-in directory
  ansible.builtin.file:
    path: /etc/systemd/system/kubelet.service.d
    state: directory
    mode: "0755"

- name: Create kubeadm kubelet drop-in configuration
  ansible.builtin.copy:
    content: |
      [Service]
      Environment="KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf"
      Environment="KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml"
      # This is a file that "kubeadm init" and "kubeadm join" generate at runtime
      EnvironmentFile=-/var/lib/kubelet/kubeadm-flags.env
      # This is a file that the user can use for overrides of the kubelet args
      EnvironmentFile=-/etc/default/kubelet
      ExecStart=
      ExecStart=/usr/local/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS
    dest: /etc/systemd/system/kubelet.service.d/10-kubeadm.conf
    mode: "0644"

- name: Reload systemd daemon
  ansible.builtin.systemd:
    daemon_reload: true

- name: Stop kubelet service
  ansible.builtin.systemd:
    name: kubelet
    state: stopped
  ignore_errors: true

- name: Enable kubelet service
  ansible.builtin.systemd:
    name: kubelet
    enabled: true

- name: Verify kubelet version
  ansible.builtin.command: /usr/local/bin/kubelet --version
  register: kubelet_verify
  changed_when: false

- name: Verify kubectl version
  ansible.builtin.command: /usr/local/bin/kubectl version --client
  register: kubectl_verify
  changed_when: false

- name: Verify kubeadm version
  ansible.builtin.command: /usr/local/bin/kubeadm version
  register: kubeadm_verify
  changed_when: false

- name: Verify crictl version
  ansible.builtin.command: /usr/local/bin/crictl --version
  register: crictl_verify
  changed_when: false

- name: Create crictl configuration file
  ansible.builtin.copy:
    content: |
      runtime-endpoint: unix:///var/run/containerd/containerd.sock
      image-endpoint: unix:///var/run/containerd/containerd.sock
      timeout: 10
      debug: false
    dest: /etc/crictl.yaml
    mode: "0644"

- name: Ensure containerd is installed via apt (not frozen)
  ansible.builtin.apt:
    name: containerd
    state: present

- name: Remove Kubernetes apt repository if exists
  ansible.builtin.file:
    path: /etc/apt/sources.list.d/kubernetes.list
    state: absent

- name: Remove Kubernetes apt keyring if exists
  ansible.builtin.file:
    path: /etc/apt/keyrings/kubernetes-apt-keyring.gpg
    state: absent

- name: Create kubernetes hold file marker
  ansible.builtin.copy:
    content: |
       # Kubernetes packages installed manually from binaries
       # Version: v{{ kubernetes_version }}.0
       # Do NOT install from apt to prevent accidental updates
       # Check /opt/kubernetes_version for installed version
    dest: /etc/kubernetes_manual_install
    mode: "0644"

- name: Clean up temporary directory
  ansible.builtin.file:
    path: "{{ k8s_temp_dir.path }}"
    state: absent
  when: k8s_binaries_need_install and k8s_temp_dir.path is defined

- name: Disable swap
  ansible.builtin.command: swapoff -a
  failed_when: false
  changed_when: false

- name: Comment out swap entry in /etc/fstab
  ansible.builtin.replace:
    path: /etc/fstab
    regexp: '^([^#].*\sswap\s.*)$'
    replace: '# \1'

- name: Load required kernel modules
  community.general.modprobe:
    name: "{{ item }}"
    state: present
  loop:
    - overlay
    - br_netfilter

- name: Enable IP forwarding and bridge networking
  ansible.posix.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    sysctl_set: true
    state: present
    reload: true
  loop:
    - { name: "net.ipv4.ip_forward", value: "1" }
    - { name: "net.bridge.bridge-nf-call-iptables", value: "1" }

- name: Create containerd config directory
  ansible.builtin.file:
    path: /etc/containerd
    state: directory
    mode: "0755"

- name: Configure containerd cgroup driver
  ansible.builtin.template:
    src: containerd-config.toml.j2
    dest: /etc/containerd/config.toml
    mode: "0644"
    backup: true
  notify: Restart containerd

- name: Restart containerd
  ansible.builtin.systemd:
    name: containerd
    state: restarted
    enabled: true


- name: Check if UFW binary exists
  ansible.builtin.stat:
    path: /usr/sbin/ufw
  register: kuber_ufw_bin

- name: Disable UFW (best-effort)
  ansible.builtin.command: ufw --force disable
  register: kuber_ufw_disable
  changed_when: >-
    kuber_ufw_disable.rc == 0 and
    (
      (kuber_ufw_disable.stdout | default('')) is search('Firewall stopped') or
      (kuber_ufw_disable.stdout | default('')) is search('disabled')
    )
  failed_when: false
  when: kuber_ufw_bin.stat.exists

- name: Stop and disable UFW service (best-effort)
  ansible.builtin.systemd:
    name: ufw
    state: stopped
    enabled: false
  failed_when: false
  when: kuber_ufw_bin.stat.exists

- name: Verify kubelet is installed
  ansible.builtin.command: kubelet --version
  register: kubelet_version
  changed_when: false
  failed_when: false

- name: Verify kubeadm is installed
  ansible.builtin.command: kubeadm version
  register: kubeadm_version
  changed_when: false
  failed_when: false

- name: Verify kubectl is installed
  ansible.builtin.command: kubectl version --client
  register: kubectl_version
  changed_when: false
  failed_when: false

- name: Assert kubelet is installed
  ansible.builtin.assert:
    that:
      - kubelet_version.rc == 0
    success_msg: "Kubelet successfully installed: {{ kubelet_version.stdout }}"
    fail_msg: "Kubelet installation verification failed"

- name: Assert kubeadm is installed
  ansible.builtin.assert:
    that:
      - kubeadm_version.rc == 0
    success_msg: "Kubeadm successfully installed: {{ kubeadm_version.stdout }}"
    fail_msg: "Kubeadm installation verification failed"

- name: Assert kubectl is installed
  ansible.builtin.assert:
    that:
      - kubectl_version.rc == 0
    success_msg: "Kubectl successfully installed: {{ kubectl_version.stdout }}"
    fail_msg: "Kubectl installation verification failed"

- name: Check swap status
  ansible.builtin.command: swapon --show
  register: swap_status
  changed_when: false
  failed_when: false

- name: Assert swap is disabled
  ansible.builtin.assert:
    that:
      - swap_status.rc != 0 or swap_status.stdout == ""
    success_msg: "Swap is disabled"
    fail_msg: "Swap is still enabled"
  when: swap_status.stdout is defined

- name: Verify overlay module is loaded
  ansible.builtin.shell: lsmod | grep overlay
  register: overlay_module
  changed_when: false
  failed_when: false

- name: Assert overlay module is loaded
  ansible.builtin.assert:
    that:
      - overlay_module.rc == 0
    success_msg: "Overlay kernel module is loaded"
    fail_msg: "Overlay kernel module is not loaded"

- name: Verify br_netfilter module is loaded
  ansible.builtin.shell: lsmod | grep br_netfilter
  register: br_netfilter_module
  changed_when: false
  failed_when: false

- name: Assert br_netfilter module is loaded
  ansible.builtin.assert:
    that:
      - br_netfilter_module.rc == 0
    success_msg: "br_netfilter kernel module is loaded"
    fail_msg: "br_netfilter kernel module is not loaded"
  when: br_netfilter_module.stdout is defined

- name: Verify containerd is running
  ansible.builtin.systemd:
    name: containerd
  register: containerd_running
  failed_when: false

- name: Assert containerd is running
  ansible.builtin.assert:
    that:
      - containerd_running.status.ActiveState == 'active'
    success_msg: "Containerd is running"
    fail_msg: "Containerd is not running"
  when: containerd_running.status is defined

- name: Display installation completion message
  ansible.builtin.debug:
    msg:
      - "=== Kubernetes Installation Complete ==="
      - "Kubelet: {{ kubelet_version.stdout }}"
      - "Kubeadm: {{ kubeadm_version.stdout }}"
      - "Kubectl: {{ kubectl_version.stdout }}"
      - "Swap: Disabled"
      - "Overlay module: Loaded"
      - "br_netfilter module: Loaded"
      - "Containerd: Running"
      - "Next step: Run kuber_plane_init.yaml (for control plane) or kuber_worker_join.yaml (for workers)"
