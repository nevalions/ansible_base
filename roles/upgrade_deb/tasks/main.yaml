---
- name: Check internet connectivity
  ansible.builtin.wait_for:
    host: [dns-server]
    port: 53
    timeout: 10

- name: Display Debian upgrade start
  ansible.builtin.debug:
    msg:
      - "=== Debian Package Upgrade Start ==="
      - "Internet connectivity: Verified"

- name: Get current package count before upgrade
  ansible.builtin.shell: dpkg -l | grep -c '^ii'
  register: packages_before
  changed_when: false

- name: Upgrade Debian packages
  become: true
  ansible.builtin.apt:
    upgrade: true
    update_cache: true

- name: Check if reboot is required
  become: true
  ansible.builtin.stat:
    path: /var/run/reboot_required
  register: reboot_required

- name: Get current package count after upgrade
  ansible.builtin.shell: dpkg -l | grep -c '^ii'
  register: packages_after
  changed_when: false

- name: Calculate packages upgraded
  ansible.builtin.set_fact:
    packages_upgraded_count: "{{ packages_after.stdout | int - packages_before.stdout | int }}"

- name: Display Debian upgrade completion
  ansible.builtin.debug:
    msg:
      - "=== Debian Package Upgrade Complete ==="
      - "Packages before: {{ packages_before.stdout }}"
      - "Packages after: {{ packages_after.stdout }}"
      - "Packages changed: {{ packages_upgraded_count }}"
      - "Reboot required: {{ 'Yes' if reboot_required.stat.exists else 'No' }}"
      - "{% if reboot_required.stat.exists %}IMPORTANT: System reboot is required{% endif %}"
