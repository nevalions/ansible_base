---
- name: Determine HAProxy backend hosts
  ansible.builtin.set_fact:
    haproxy_k8s_backend_hosts_dynamic: "{{ vault_k8s_control_planes | default(haproxy_k8s_backend_hosts) }}"

- name: Validate HAProxy backend hosts from vault
  ansible.builtin.assert:
    that:
      - host.wireguard_ip is defined
      - host.backend_port is defined
    success_msg: "Backend host {{ host.name | default('[control-plane]') }} has required fields"
    fail_msg: "Backend host is missing wireguard_ip or backend_port"
  loop: "{{ haproxy_k8s_backend_hosts_dynamic }}"
  loop_control:
    loop_var: host
  when: haproxy_k8s_backend_hosts_dynamic | length > 0

- name: Ensure HAProxy is installed
  ansible.builtin.apt:
    name:
      - haproxy
    state: present
    update_cache: true

- name: Check if UFW is installed
  ansible.builtin.stat:
    path: /usr/sbin/ufw
  register: ufw_bin

- name: Check if UFW is active
  ansible.builtin.command: ufw status
  register: ufw_status
  changed_when: false
  failed_when: false
  when: ufw_bin.stat.exists

- name: Set UFW active fact
  ansible.builtin.set_fact:
    ufw_is_active: "{{ ufw_bin.stat.exists | default(false) and (ufw_status.stdout | default('')) is search('Status: active') }}"

- name: Configure UFW to allow WireGuard network access to HAProxy (K8s API)
  community.general.ufw:
    rule: allow
    proto: tcp
    port: "{{ haproxy_k8s_frontend_port | int }}"
    from: "{{ net }}"
    direction: in
  loop: "{{ haproxy_k8s_allowed_networks }}"
  loop_control:
    loop_var: net
  when:
    - ansible_facts['os_family'] == 'Debian'
    - ufw_is_active | bool
    - not (haproxy_k8s_skip_ufw | default(false) | bool)
    - haproxy_k8s_allowed_networks | length > 0

- name: Configure UFW to allow HTTP from anywhere (ingress)
  community.general.ufw:
    rule: allow
    proto: tcp
    port: "{{ haproxy_ingress_http_port | int }}"
    direction: in
  when:
    - haproxy_ingress_enabled | default(false) | bool
    - ansible_facts['os_family'] == 'Debian'
    - ufw_is_active | bool

- name: Configure UFW to allow HTTPS from anywhere (ingress)
  community.general.ufw:
    rule: allow
    proto: tcp
    port: "{{ haproxy_ingress_https_port | int }}"
    direction: in
  when:
    - haproxy_ingress_enabled | default(false) | bool
    - ansible_facts['os_family'] == 'Debian'
    - ufw_is_active | bool

- name: Check if HAProxy config exists
  ansible.builtin.stat:
    path: /etc/haproxy/haproxy.cfg
  register: haproxy_config

- name: Backup existing HAProxy config
  ansible.builtin.copy:
    src: /etc/haproxy/haproxy.cfg
    dest: /etc/haproxy/haproxy.cfg.backup.{{ ansible_facts['date_time']['epoch'] }}
    remote_src: true
    mode: "0640"
  when: haproxy_config.stat.exists

- name: Deploy HAProxy configuration for Kubernetes API
  ansible.builtin.template:
    src: haproxy.cfg.j2
    dest: /etc/haproxy/haproxy.cfg
    mode: "0640"
    validate: "haproxy -c -f %s"
  notify: Restart HAProxy

- name: Ensure HAProxy is enabled and started
  ansible.builtin.systemd:
    name: haproxy
    state: started
    enabled: true

- name: Wait for HAProxy to be ready (K8s API port)
  ansible.builtin.wait_for:
    port: "{{ haproxy_k8s_frontend_port | int }}"
    delay: 2
    timeout: 30

- name: Verify HAProxy is listening on all interfaces
  ansible.builtin.shell: ss -tlnp | grep '{{ haproxy_k8s_frontend_port }}'
  register: haproxy_listening
  changed_when: false
  failed_when: false

- name: Debug listening check
  ansible.builtin.debug:
    msg: "Port {{ haproxy_k8s_frontend_port }} listening: {{ 'YES' if haproxy_listening.rc == 0 else 'NO' }} (rc={{ haproxy_listening.rc }})"

- name: Assert HAProxy is listening (K8s API)
  ansible.builtin.assert:
    that:
      - haproxy_listening.rc == 0
    success_msg: "HAProxy is listening on port {{ haproxy_k8s_frontend_port }}"
    fail_msg: "HAProxy is not listening on port {{ haproxy_k8s_frontend_port }}"

- name: Verify HAProxy is listening on HTTP ingress port
  ansible.builtin.shell: ss -tlnp | grep ':{{ haproxy_ingress_http_port }}'
  register: haproxy_http_listening
  changed_when: false
  failed_when: false
  when: haproxy_ingress_enabled | default(false) | bool

- name: Assert HAProxy is listening (HTTP ingress)
  ansible.builtin.assert:
    that:
      - haproxy_http_listening.rc == 0
    success_msg: "HAProxy is listening on port {{ haproxy_ingress_http_port }} (HTTP ingress)"
    fail_msg: "HAProxy is not listening on port {{ haproxy_ingress_http_port }} (HTTP ingress)"
  when: haproxy_ingress_enabled | default(false) | bool

- name: Verify HAProxy is listening on HTTPS ingress port
  ansible.builtin.shell: ss -tlnp | grep ':{{ haproxy_ingress_https_port }}'
  register: haproxy_https_listening
  changed_when: false
  failed_when: false
  when: haproxy_ingress_enabled | default(false) | bool

- name: Assert HAProxy is listening (HTTPS ingress)
  ansible.builtin.assert:
    that:
      - haproxy_https_listening.rc == 0
    success_msg: "HAProxy is listening on port {{ haproxy_ingress_https_port }} (HTTPS ingress)"
    fail_msg: "HAProxy is not listening on port {{ haproxy_ingress_https_port }} (HTTPS ingress)"
  when: haproxy_ingress_enabled | default(false) | bool

- name: Wait for HAProxy ingress HTTP port
  ansible.builtin.wait_for:
    port: "{{ haproxy_ingress_http_port | int }}"
    delay: 2
    timeout: 30
  when: haproxy_ingress_enabled | default(false) | bool

- name: Wait for HAProxy ingress HTTPS port
  ansible.builtin.wait_for:
    port: "{{ haproxy_ingress_https_port | int }}"
    delay: 2
    timeout: 30
  when: haproxy_ingress_enabled | default(false) | bool

- name: Verify ingress backend (BGP VIP) is reachable on HTTP
  ansible.builtin.wait_for:
    host: "{{ haproxy_ingress_backend_ip }}"
    port: "{{ haproxy_ingress_backend_http_port | int }}"
    timeout: 10
  register: ingress_http_backend_check
  changed_when: false
  failed_when: false
  ignore_errors: true
  when: haproxy_ingress_enabled | default(false) | bool

- name: Display ingress HTTP backend connectivity
  ansible.builtin.debug:
    msg: "Ingress HTTP backend {{ haproxy_ingress_backend_ip }}:{{ haproxy_ingress_backend_http_port }} {{ 'reachable' if ingress_http_backend_check is not failed else 'NOT reachable (check BGP VIP and Traefik)' }}"
  when: haproxy_ingress_enabled | default(false) | bool

- name: Verify ingress backend (BGP VIP) is reachable on HTTPS
  ansible.builtin.wait_for:
    host: "{{ haproxy_ingress_backend_ip }}"
    port: "{{ haproxy_ingress_backend_https_port | int }}"
    timeout: 10
  register: ingress_https_backend_check
  changed_when: false
  failed_when: false
  ignore_errors: true
  when: haproxy_ingress_enabled | default(false) | bool

- name: Display ingress HTTPS backend connectivity
  ansible.builtin.debug:
    msg: "Ingress HTTPS backend {{ haproxy_ingress_backend_ip }}:{{ haproxy_ingress_backend_https_port }} {{ 'reachable' if ingress_https_backend_check is not failed else 'NOT reachable (check BGP VIP and Traefik)' }}"
  when: haproxy_ingress_enabled | default(false) | bool

- name: Verify HAProxy backend hosts are reachable
  ansible.builtin.wait_for:
    host: "{{ host.wireguard_ip }}"
    port: "{{ host.backend_port }}"
    timeout: 5
  loop: "{{ haproxy_k8s_backend_hosts_dynamic }}"
  loop_control:
    loop_var: host
  register: backend_check_result
  changed_when: false
  failed_when: false
  ignore_errors: true
  when: haproxy_k8s_backend_hosts_dynamic | length > 0
