# HAProxy Configuration for Kubernetes API Server
# Managed by Ansible - DO NOT EDIT MANUALLY

global
    maxconn {{ haproxy_k8s_maxconn }}
    log /dev/log local0
    log /dev/log local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

defaults
    log     global
    mode    tcp
    option  tcplog
    option  dontlognull
    timeout connect {{ haproxy_k8s_timeout_connect }}
    timeout client  {{ haproxy_k8s_timeout_client }}
    timeout server  {{ haproxy_k8s_timeout_server }}
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http

# BEGIN ANSIBLE MANAGED SECTION - Kubernetes API Frontend
frontend k8s-api-frontend
    bind *:{{ haproxy_k8s_frontend_port }}
    mode tcp
    option tcplog
    timeout client {{ haproxy_k8s_timeout_client }}
    default_backend k8s-api-backend
# END ANSIBLE MANAGED SECTION - Kubernetes API Frontend

# BEGIN ANSIBLE MANAGED SECTION - Kubernetes API Backend
backend k8s-api-backend
    mode tcp
    balance roundrobin
    option tcp-check
    timeout connect {{ haproxy_k8s_timeout_connect }}
    timeout server  {{ haproxy_k8s_timeout_server }}
 {% for host in haproxy_k8s_backend_hosts_dynamic | default(haproxy_k8s_backend_hosts) %}
     server {{ host.name }} {{ host.wireguard_ip }}:{{ host.backend_port }} check inter {{ haproxy_k8s_check_interval }} rise {{ haproxy_k8s_check_rise }} fall {{ haproxy_k8s_check_fall }}
 {% endfor %}
# END ANSIBLE MANAGED SECTION - Kubernetes API Backend
