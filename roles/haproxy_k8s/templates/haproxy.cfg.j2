# HAProxy Configuration for Kubernetes
# Managed by Ansible - DO NOT EDIT MANUALLY

global
    maxconn {{ haproxy_k8s_maxconn }}
    log /dev/log local0
    log /dev/log local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

defaults
    log     global
    mode    tcp
    option  tcplog
    option  dontlognull
    timeout connect {{ haproxy_k8s_timeout_connect }}
    timeout client  {{ haproxy_k8s_timeout_client }}
    timeout server  {{ haproxy_k8s_timeout_server }}
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http

# BEGIN ANSIBLE MANAGED SECTION - Kubernetes API Frontend
frontend k8s-api-frontend
    bind *:{{ haproxy_k8s_frontend_port }}
    mode tcp
    option tcplog
    timeout client {{ haproxy_k8s_timeout_client }}
    default_backend k8s-api-backend
# END ANSIBLE MANAGED SECTION - Kubernetes API Frontend

# BEGIN ANSIBLE MANAGED SECTION - Kubernetes API Backend
backend k8s-api-backend
    mode tcp
    balance roundrobin
    option tcp-check
    timeout connect {{ haproxy_k8s_timeout_connect }}
    timeout server  {{ haproxy_k8s_timeout_server }}
{% for host in haproxy_k8s_backend_hosts_dynamic | default(haproxy_k8s_backend_hosts) %}
    server {{ host.name }} {{ host.wireguard_ip }}:{{ host.backend_port }} check inter {{ haproxy_k8s_check_interval }} rise {{ haproxy_k8s_check_rise }} fall {{ haproxy_k8s_check_fall }}
{% endfor %}
# END ANSIBLE MANAGED SECTION - Kubernetes API Backend

{% if haproxy_ingress_enabled | default(false) | bool %}
# =============================================================================
# INGRESS LOAD BALANCING (HTTP/HTTPS to Kubernetes via BGP VIP)
# =============================================================================
# Traffic flow: Internet -> HAProxy -> BGP VIP -> FRR -> MetalLB -> Traefik -> App

# BEGIN ANSIBLE MANAGED SECTION - Ingress HTTP Frontend
frontend ingress-http
    bind *:{{ haproxy_ingress_http_port }}
    mode tcp
    option tcplog
    timeout client {{ haproxy_k8s_timeout_client }}
    default_backend ingress-http-backend
# END ANSIBLE MANAGED SECTION - Ingress HTTP Frontend

# BEGIN ANSIBLE MANAGED SECTION - Ingress HTTP Backend
backend ingress-http-backend
    mode tcp
    option tcp-check
    timeout connect {{ haproxy_k8s_timeout_connect }}
    timeout server  {{ haproxy_k8s_timeout_server }}
    server bgp-vip {{ haproxy_ingress_backend_ip }}:{{ haproxy_ingress_backend_http_port }} check inter {{ haproxy_k8s_check_interval }} rise {{ haproxy_k8s_check_rise }} fall {{ haproxy_k8s_check_fall }}{% if haproxy_ingress_proxy_protocol | default(false) | bool %} send-proxy-v2{% endif %}
# END ANSIBLE MANAGED SECTION - Ingress HTTP Backend

# BEGIN ANSIBLE MANAGED SECTION - Ingress HTTPS Frontend
frontend ingress-https
    bind *:{{ haproxy_ingress_https_port }}
    mode tcp
    option tcplog
    timeout client {{ haproxy_k8s_timeout_client }}
    default_backend ingress-https-backend
# END ANSIBLE MANAGED SECTION - Ingress HTTPS Frontend

# BEGIN ANSIBLE MANAGED SECTION - Ingress HTTPS Backend
backend ingress-https-backend
    mode tcp
    option tcp-check
    timeout connect {{ haproxy_k8s_timeout_connect }}
    timeout server  {{ haproxy_k8s_timeout_server }}
    server bgp-vip {{ haproxy_ingress_backend_ip }}:{{ haproxy_ingress_backend_https_port }} check inter {{ haproxy_k8s_check_interval }} rise {{ haproxy_k8s_check_rise }} fall {{ haproxy_k8s_check_fall }}{% if haproxy_ingress_proxy_protocol | default(false) | bool %} send-proxy-v2{% endif %}
# END ANSIBLE MANAGED SECTION - Ingress HTTPS Backend
{% endif %}

{% if haproxy_mail_enabled | default(false) | bool %}
# =============================================================================
# MAIL SERVER LOAD BALANCING (SMTP/IMAP to Kubernetes via MetalLB)
# =============================================================================
# Traffic flow: Internet -> HAProxy -> MetalLB LB IP -> Stalwart Mail Pod

# BEGIN ANSIBLE MANAGED SECTION - Mail SMTP Frontend
frontend mail-smtp
    bind *:{{ haproxy_mail_smtp_port }}
    mode tcp
    option tcplog
    timeout client {{ haproxy_mail_timeout_client }}
    default_backend mail-smtp-backend
# END ANSIBLE MANAGED SECTION - Mail SMTP Frontend

# BEGIN ANSIBLE MANAGED SECTION - Mail SMTP Backend
backend mail-smtp-backend
    mode tcp
    option tcp-check
    timeout connect {{ haproxy_k8s_timeout_connect }}
    timeout server  {{ haproxy_mail_timeout_server }}
    server stalwart {{ haproxy_mail_backend_ip }}:{{ haproxy_mail_backend_smtp_port }} check inter 5000 rise {{ haproxy_k8s_check_rise }} fall {{ haproxy_k8s_check_fall }}{% if haproxy_mail_proxy_protocol | default(false) | bool %} send-proxy-v2{% endif %}

# END ANSIBLE MANAGED SECTION - Mail SMTP Backend

# BEGIN ANSIBLE MANAGED SECTION - Mail SMTPS Frontend
frontend mail-smtps
    bind *:{{ haproxy_mail_smtps_port }}
    mode tcp
    option tcplog
    timeout client {{ haproxy_mail_timeout_client }}
    default_backend mail-smtps-backend
# END ANSIBLE MANAGED SECTION - Mail SMTPS Frontend

# BEGIN ANSIBLE MANAGED SECTION - Mail SMTPS Backend
backend mail-smtps-backend
    mode tcp
    option tcp-check
    timeout connect {{ haproxy_k8s_timeout_connect }}
    timeout server  {{ haproxy_mail_timeout_server }}
    server stalwart {{ haproxy_mail_backend_ip }}:{{ haproxy_mail_backend_smtps_port }} check inter 5000 rise {{ haproxy_k8s_check_rise }} fall {{ haproxy_k8s_check_fall }}{% if haproxy_mail_proxy_protocol | default(false) | bool %} send-proxy-v2{% endif %}

# END ANSIBLE MANAGED SECTION - Mail SMTPS Backend

# BEGIN ANSIBLE MANAGED SECTION - Mail Submission Frontend
frontend mail-submission
    bind *:{{ haproxy_mail_submission_port }}
    mode tcp
    option tcplog
    timeout client {{ haproxy_mail_timeout_client }}
    default_backend mail-submission-backend
# END ANSIBLE MANAGED SECTION - Mail Submission Frontend

# BEGIN ANSIBLE MANAGED SECTION - Mail Submission Backend
backend mail-submission-backend
    mode tcp
    option tcp-check
    timeout connect {{ haproxy_k8s_timeout_connect }}
    timeout server  {{ haproxy_mail_timeout_server }}
    server stalwart {{ haproxy_mail_backend_ip }}:{{ haproxy_mail_backend_submission_port }} check inter 5000 rise {{ haproxy_k8s_check_rise }} fall {{ haproxy_k8s_check_fall }}{% if haproxy_mail_proxy_protocol | default(false) | bool %} send-proxy-v2{% endif %}

# END ANSIBLE MANAGED SECTION - Mail Submission Backend

# BEGIN ANSIBLE MANAGED SECTION - Mail IMAPS Frontend
frontend mail-imaps
    bind *:{{ haproxy_mail_imaps_port }}
    mode tcp
    option tcplog
    timeout client {{ haproxy_mail_timeout_client }}
    default_backend mail-imaps-backend
# END ANSIBLE MANAGED SECTION - Mail IMAPS Frontend

# BEGIN ANSIBLE MANAGED SECTION - Mail IMAPS Backend
backend mail-imaps-backend
    mode tcp
    option tcp-check
    timeout connect {{ haproxy_k8s_timeout_connect }}
    timeout server  {{ haproxy_mail_timeout_server }}
    server stalwart {{ haproxy_mail_backend_ip }}:{{ haproxy_mail_backend_imaps_port }} check inter 5000 rise {{ haproxy_k8s_check_rise }} fall {{ haproxy_k8s_check_fall }}{% if haproxy_mail_proxy_protocol | default(false) | bool %} send-proxy-v2{% endif %}

# END ANSIBLE MANAGED SECTION - Mail IMAPS Backend
{% endif %}
