---
# Control plane endpoint: DNS or VIP
# Priority: DNS (if enabled) -> VIP
kuber_join_control_plane_host: >-
  {{
    (vault_k8s_api_dns | default('VIP'))
    if (vault_k8s_use_dns_endpoint | default(false))
    else 'VIP'
  }}
kuber_join_control_plane_ip: >-
  {{
    (vault_k8s_api_dns | default(''))
    if (vault_k8s_use_dns_endpoint | default(false))
    else (vault_k8s_api_vip | default('[vip-address]'))
  }}
kuber_join_api_port: "{{ vault_k8s_api_port | default('[k8s-api-port]') }}"
kuber_join_token_ttl: "0"

# SSH delegation target - always use inventory hostname for SSH
# Never use DNS name for SSH delegation to avoid resolution issues
kuber_join_control_plane_ssh_host: "{{ groups['planes_all'][0] | default('') }}"
kuber_join_kubelet_extra_args:
  node-ip: >-
    {{
      ansible_facts.get(vault_interface | default('wg99'), {})
      .get('ipv4', {})
      .get('address', ansible_default_ipv4.address)
    }}
kubeadm_api_version: "v1beta4"

# CNI validation after worker join
# Global source of truth: vault_k8s_cni_type (example: flannel or calico)
kuber_join_cni_type: "{{ vault_k8s_cni_type | default('flannel') }}"
kuber_join_cni_namespace: "{{ 'kube-flannel' if kuber_join_cni_type == 'flannel' else 'kube-system' }}"
kuber_join_cni_label_selector: "{{ 'app=flannel' if kuber_join_cni_type == 'flannel' else 'k8s-app=calico-node' }}"

# Node-local DNS verification after worker join
kuber_join_node_dns_probe_enabled: true
kuber_join_node_dns_probe_domain: "kubernetes.default.svc.cluster.local"
kuber_join_node_dns_probe_image: "busybox:1.36"
kuber_join_node_dns_probe_namespace: "kube-system"
kuber_join_node_dns_probe_retries: "20"
kuber_join_node_dns_probe_delay: "3"
kuber_join_node_dns_auto_repair: true
