---
- name: Ensure ufw is installed
  ansible.builtin.apt:
    name: ufw
    state: present
  when: ansible_os_family == 'Debian'

- name: Allow DNS through firewall from allowed networks
  community.general.ufw:
    rule: allow
    proto: udp
    port: "53"
    src: "{{ item }}"
  loop: "{{ vault_dns_allowed_networks | default(['0.0.0.0/0']) }}"
  when: ansible_os_family == 'Debian'

- name: Allow DNS through firewall (TCP) from allowed networks
  community.general.ufw:
    rule: allow
    proto: tcp
    port: "53"
    src: "{{ item }}"
  loop: "{{ vault_dns_allowed_networks | default(['0.0.0.0/0']) }}"
  when: ansible_os_family == 'Debian'

- name: Check UFW status
  ansible.builtin.command: ufw status
  register: ufw_status
  changed_when: false
  when: ansible_os_family == 'Debian'

- name: Display UFW status
  ansible.builtin.debug:
    var: ufw_status.stdout_lines
  when:
    - ansible_os_family == 'Debian'
    - ufw_status.stdout_lines is defined

- name: Verify DNS firewall rules are present
  ansible.builtin.assert:
    that:
      - "'53' in ufw_status.stdout"
    success_msg: "DNS firewall rules are present"
    fail_msg: "DNS firewall rules not found in UFW"
  when:
    - ansible_os_family == 'Debian'
    - dns_operation == "install"
