server:
    interface: {{ dns_listen_interface }}
{% for network in vault_dns_allowed_networks | default(["0.0.0.0/0"]) %}
    access-control: {{ network }} allow
{% endfor %}
    do-ip6: {{ "yes" if dns_do_ipv6 else "no" }}
    rrset-cache-size: {{ dns_cache_size }}m
    msg-cache-size: {{ dns_cache_size }}m

{% set valid_upstreams = (dns_upstream_dns | default([])
  | reject('match', '^\[.*\]$')
  | select('match', '^(?:\d{1,3}\.){3}\d{1,3}$')
  | list) %}
{% set effective_upstreams = valid_upstreams if (valid_upstreams | length > 0) else ['1.1.1.1', '8.8.8.8'] %}

forward-zone:
    name: "."
{% for upstream in effective_upstreams %}
    forward-addr: {{ upstream }}
{% endfor %}

include: /etc/unbound/unbound.conf.d/zone.conf
