---
# Control plane endpoint: DNS or VIP
# Priority: DNS (if enabled) -> VIP
kuber_plane_join_control_plane_host: >-
  {{
    (vault_k8s_api_dns | default('VIP'))
    if (vault_k8s_use_dns_endpoint | default(false))
    else 'VIP'
  }}
kuber_plane_join_control_plane_ip: >-
  {{
    (vault_k8s_api_dns | default(''))
    if (vault_k8s_use_dns_endpoint | default(false))
    else (vault_k8s_api_vip | default('[vip-address]'))
  }}
kuber_plane_join_api_port: "{{ vault_k8s_api_port | default('[k8s-api-port]') }}"
kuber_plane_join_token_ttl: "0"

# SSH delegation target - always use inventory hostname for SSH
# Never use DNS name for SSH delegation to avoid resolution issues
kuber_plane_join_control_plane_ssh_host: "{{ groups['planes_all'][0] | default('') }}"
kuber_plane_join_kubelet_extra_args:
  node-ip: >-
    {{
      ansible_facts.get(vault_interface | default('wg99'), {})
      .get('ipv4', {})
      .get('address', ansible_default_ipv4.address)
    }}
kubeadm_api_version: "v1beta4"

# Kubelet graceful shutdown grace periods
# Ensures in-flight pod lifecycle completes before kubelet exits on SIGTERM
kuber_plane_join_shutdown_grace_period: "60s"
kuber_plane_join_shutdown_grace_period_critical_pods: "20s"

# Safety behavior when target node is already part of a cluster
# true: fail fast and require explicit reset
# false: skip join tasks for that host and continue the play
kuber_plane_join_fail_if_already_joined: true

# CNI validation after control plane join
# Global source of truth: vault_k8s_cni_type (example: flannel or calico)
kuber_plane_join_cni_type: "{{ vault_k8s_cni_type | default('flannel') }}"
kuber_plane_join_cni_namespace: "{{ 'kube-flannel' if kuber_plane_join_cni_type == 'flannel' else 'kube-system' }}"
kuber_plane_join_cni_label_selector: "{{ 'app=flannel' if kuber_plane_join_cni_type == 'flannel' else 'k8s-app=calico-node' }}"
