---
- name: Display peer deployment info
  ansible.builtin.debug:
    msg:
      - "Configuring WireGuard client for {{ peer_config.name }}"
      - "Interface: {{ vault_wg_interface }}"
      - "Address: {{ peer_config.address | default(peer_config.allowed_ips) }}"
      - "Listen port: {{ peer_config.client_listen_port | default(vault_wg_client_default_port) }}"

- name: Check if resolvconf is available
  ansible.builtin.command: command -v resolvconf
  register: resolvconf_check
  changed_when: false
  failed_when: false

- name: Set DNS usage for WireGuard client config
  ansible.builtin.set_fact:
    wg_use_dns: "{{ wg_dns_enabled and (resolvconf_check.rc == 0) }}"

- name: Warn when DNS configuration is skipped
  ansible.builtin.debug:
    msg: "resolvconf not found; skipping DNS in WireGuard client config"
  when: not wg_use_dns

- name: Check if peer WireGuard config exists
  ansible.builtin.stat:
    path: "/etc/wireguard/{{ vault_wg_interface }}.conf"
  register: peer_wg_config_exists

- name: Backup existing peer WireGuard config
  ansible.builtin.copy:
    src: "/etc/wireguard/{{ vault_wg_interface }}.conf"
    dest: "/etc/wireguard/backups/{{ vault_wg_interface }}.conf.backup.{{ ansible_facts['date_time']['iso8601'] }}"
    remote_src: yes
    mode: '0600'
  when:
    - peer_wg_config_exists.stat.exists
    - operation == "install"
    - not ansible_check_mode

- name: Deploy WireGuard client configuration
  ansible.builtin.template:
    src: client.conf.j2
    dest: "/etc/wireguard/{{ vault_wg_interface }}.conf"
    mode: '0600'
    backup: yes
  register: peer_config_deployed
  when: operation == "install"

- name: Stop WireGuard service before configuration change (peer)
  ansible.builtin.systemd:
    name: "wg-quick@{{ vault_wg_interface }}"
    state: stopped
  when:
    - operation == "install"
    - peer_config_deployed.changed
    - not ansible_check_mode
  ignore_errors: true

- name: Remove WireGuard client configuration
  ansible.builtin.file:
    path: "/etc/wireguard/{{ vault_wg_interface }}.conf"
    state: absent
  notify: stop wireguard
  when: operation == "remove"

- name: Enable WireGuard service on boot (peer)
  ansible.builtin.systemd:
    name: "wg-quick@{{ vault_wg_interface }}"
    enabled: yes
    daemon_reload: yes
  when: operation == "install"

- name: Start or restart WireGuard service (peer)
  ansible.builtin.systemd:
    name: "wg-quick@{{ vault_wg_interface }}"
    state: "{{ 'restarted' if peer_config_deployed.changed else 'started' }}"
  when: operation == "install"
  register: peer_service_start
  ignore_errors: true

- name: Display service result
  ansible.builtin.debug:
    msg: "Service start {{ 'succeeded' if peer_service_start is succeeded else 'failed' }}: {{ peer_service_start.msg | default('OK') }}"

- name: Get peer WireGuard status
  ansible.builtin.shell: wg show {{ vault_wg_interface }}
  register: peer_wg_status
  changed_when: false
  when:
    - operation == "install"
    - not ansible_check_mode
    - peer_service_start is succeeded

- name: Display peer WireGuard status
  ansible.builtin.debug:
    var: peer_wg_status.stdout_lines
  when:
    - operation == "install"
    - not ansible_check_mode
    - peer_wg_status.stdout_lines is defined
    - peer_service_start is succeeded
