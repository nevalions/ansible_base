---
- name: Set debconf for non-interactive APT
  ansible.builtin.shell: echo 'debconf debconf/frontend select Noninteractive' | debconf-set-selections
  changed_when: false
  when: ansible_facts['os_family'] == 'Debian'

- name: Ensure UFW is installed
  ansible.builtin.shell: DEBIAN_FRONTEND=noninteractive apt-get install -y ufw
  register: ufw_install
  changed_when: "'0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.' not in ufw_install.stdout"
  when: ansible_facts['os_family'] == 'Debian'

- name: Check if WireGuard server port rule already exists
  ansible.builtin.command: ufw status | grep "{{ vault_wg_server_port }}"
  register: existing_wg_rules
  changed_when: false
  failed_when: false
  when:
    - ansible_facts['os_family'] == 'Debian'
    - vault_wg_allowed_networks is defined

- name: Allow WireGuard server port from allowed networks
  community.general.ufw:
    rule: allow
    proto: udp
    port: "{{ vault_wg_server_port }}"
    src: "{{ item }}"
  loop: "{{ vault_wg_allowed_networks }}"
  when:
    - ansible_facts['os_family'] == 'Debian'
    - vault_wg_allowed_networks is defined
    - vault_wg_server_port | string not in (existing_wg_rules.stdout | default(''))
  ignore_errors: true
  register: wg_server_firewall_rules

- name: Display server firewall rule results
  ansible.builtin.debug:
    msg: "WireGuard server port {{ vault_wg_server_port }} from {{ item.item }}: {{ 'ADDED' if item.changed else 'EXISTS' }}"
  loop: "{{ wg_server_firewall_rules.results | default([]) }}"
  when:
    - ansible_facts['os_family'] == 'Debian'
    - vault_wg_allowed_networks is defined
    - wg_server_firewall_rules.results is defined
  ignore_errors: true

- name: Allow NAT-forwarded WireGuard ports from peer endpoints
  community.general.ufw:
    rule: allow
    proto: udp
    port: "{{ item.client_listen_port | default(vault_wg_client_default_port) }}"
    src: "{{ item.endpoint | regex_replace(':\\d+$', '') }}"
  loop: "{{ vault_wg_peers }}"
  when:
    - ansible_facts['os_family'] == 'Debian'
    - item.endpoint is defined
  ignore_errors: true
  register: wg_nat_firewall_rules

- name: Display NAT firewall rule results
  ansible.builtin.debug:
    msg: "NAT port {{ item.item.client_listen_port | default(vault_wg_client_default_port) }} from {{ item.item.endpoint | regex_replace(':\\d+$', '') if item.item.endpoint is defined else 'unknown' }}: {{ 'ADDED' if item.changed else 'EXISTS/FAILED' }}"
  loop: "{{ wg_nat_firewall_rules.results | default([]) }}"
  when:
    - ansible_facts['os_family'] == 'Debian'
    - wg_nat_firewall_rules.results is defined
  ignore_errors: true

- name: Allow WireGuard internal listening ports from peer endpoints
  ansible.builtin.command:
    cmd: "ufw allow proto udp from {{ item.endpoint | regex_replace(':\\d+$', '') }} to any port {{ item.client_listen_port | default(vault_wg_client_default_port) }}"
  loop: "{{ vault_wg_peers }}"
  when:
    - ansible_facts['os_family'] == 'Debian'
    - item.client_listen_port is defined
  ignore_errors: true
  register: wg_internal_port_rules

- name: Display internal port firewall rule results
  ansible.builtin.debug:
    msg: "Internal port {{ item.item.client_listen_port | default(vault_wg_client_default_port) }} from {{ item.item.endpoint | regex_replace(':\\d+$', '') if item.item.endpoint is defined else 'unknown' }}: {{ 'ADDED' if item.changed else 'EXISTS/FAILED' }}"
  loop: "{{ wg_internal_port_rules.results | default([]) }}"
  when:
    - ansible_facts['os_family'] == 'Debian'
    - wg_internal_port_rules.results is defined
  ignore_errors: true

- name: Check UFW status
  ansible.builtin.command: ufw status
  register: ufw_status
  changed_when: false
  when: ansible_facts['os_family'] == 'Debian'

- name: Check if UFW is currently active
  ansible.builtin.set_fact:
    ufw_active: "{{ 'Status: active' in ufw_status.stdout }}"
  when: ansible_facts['os_family'] == 'Debian'

- name: Report UFW status (not managed by WireGuard role)
  ansible.builtin.debug:
    msg: >-
      UFW status: {{ 'active' if (ufw_active | default(false)) else 'inactive' }}.
      This role does not enable UFW automatically.
  when:
    - ansible_facts['os_family'] == 'Debian'
    - wg_operation == "install"
    - not ansible_check_mode
