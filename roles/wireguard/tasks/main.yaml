---
- name: Display WireGuard management start
  ansible.builtin.debug:
    msg:
      - "=== WireGuard {{ vault_wg_interface }} Management ==="
      - "Interface: {{ vault_wg_interface }}"
      - "Server port: {{ vault_wg_server_port }}"
      - "Network: {{ vault_wg_network_cidr }}"
      - "Server IP: {{ vault_wg_server_ip }}"
      - "Peers: {{ vault_wg_peers | length }}"
      - "Operation: {{ wg_operation }}"

- name: Apply WireGuard installation tasks
  block:
    - ansible.builtin.import_tasks: install.yaml

    - name: Check if running on server or client
      ansible.builtin.set_fact:
        is_wireguard_server: "{{ inventory_hostname in groups.get('wireguard_servers', []) }}"

    - ansible.builtin.import_tasks: assign_ports.yaml
      when: is_wireguard_server | default(false)

    - ansible.builtin.import_tasks: generate_keys.yaml
      when: is_wireguard_server | default(false)

    - ansible.builtin.import_tasks: configure.yaml
      when: is_wireguard_server | default(false)

    - ansible.builtin.import_tasks: firewall.yaml
      when: is_wireguard_server | default(false)

    - ansible.builtin.import_tasks: deploy_peers.yaml
      when: is_wireguard_server | default(false)

    - name: Verify WireGuard service is running
      ansible.builtin.systemd:
        name: "wg-quick@{{ vault_wg_interface }}"
      register: wg_service_status
      until: wg_service_status.status.ActiveState == 'active'
      retries: 5
      delay: 2
      when: is_wireguard_server | default(false) and not ansible_check_mode

    - name: Assert WireGuard service is active
      ansible.builtin.assert:
        that:
          - wg_service_status.status.ActiveState == 'active'
        success_msg: "WireGuard service is running"
        fail_msg: "WireGuard service is not running"
      when:
        - is_wireguard_server | default(false)
        - not ansible_check_mode
        - wg_service_status.status is defined
  when: wg_operation == "install"

- name: Apply WireGuard removal tasks
  block:
    - ansible.builtin.import_tasks: remove.yaml

    - name: Check if running on server or client
      ansible.builtin.set_fact:
        is_wireguard_server: "{{ inventory_hostname in groups.get('wireguard_servers', []) }}"

    - ansible.builtin.import_tasks: deploy_peers.yaml
  when: wg_operation == "remove"

- name: Display WireGuard management completion
  ansible.builtin.debug:
    msg:
      - "=== WireGuard {{ vault_wg_interface }} Management Complete ==="
      - "Operation: {{ wg_operation }}"
      - "Peers configured: {{ vault_wg_peers | length }}"
