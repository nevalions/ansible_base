---
- name: Set debconf for non-interactive APT
  ansible.builtin.shell: echo 'debconf debconf/frontend select Noninteractive' | debconf-set-selections
  changed_when: false
  when: ansible_facts['os_family'] == 'Debian'

- name: Ensure UFW is installed
  ansible.builtin.shell: DEBIAN_FRONTEND=noninteractive apt-get install -y ufw
  register: ufw_install
  changed_when: "'0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.' not in ufw_install.stdout"
  when: ansible_facts['os_family'] == 'Debian'

- name: Allow WireGuard client listen port
  community.general.ufw:
    rule: allow
    proto: udp
    port: "{{ peer_config.client_listen_port | default(vault_wg_client_default_port) }}"
  when: ansible_facts['os_family'] == 'Debian'

- name: Allow persistent keepalive traffic to server
  community.general.ufw:
    rule: allow
    proto: udp
    port: "{{ vault_wg_server_port }}"
    src: "{{ server_public_ip | default(ansible_facts['default_ipv4']['address']) }}"
  when: ansible_facts['os_family'] == 'Debian'

- name: Check UFW status
  ansible.builtin.command: ufw status
  register: ufw_status
  changed_when: false
  when: ansible_facts['os_family'] == 'Debian'

- name: Check if UFW is currently active
  ansible.builtin.set_fact:
    ufw_active: "{{ 'active' in ufw_status.stdout }}"
  when: ansible_facts['os_family'] == 'Debian'

- name: Report UFW status (not managed by WireGuard role)
  ansible.builtin.debug:
    msg: >-
      UFW status: {{ 'active' if (ufw_active | default(false)) else 'inactive' }}.
      This role does not enable UFW automatically.
  when:
    - ansible_facts['os_family'] == 'Debian'
    - operation == "install"
    - not ansible_check_mode

- name: Display UFW status
  ansible.builtin.debug:
    var: ufw_status.stdout_lines
  when:
    - ansible_facts['os_family'] == 'Debian'
    - ufw_status.stdout_lines is defined
    - operation == "install"
    - not ansible_check_mode
