---
- name: Check if existing WireGuard config exists
  ansible.builtin.stat:
    path: "/etc/wireguard/{{ vault_wg_interface }}.conf"
  register: wg_config_exists
 
- name: Ensure backup directory exists before backup
  ansible.builtin.file:
    path: /etc/wireguard/backups
    state: directory
    mode: '0700'
  when: not ansible_check_mode
 
- name: Backup existing WireGuard config
  ansible.builtin.copy:
    src: "/etc/wireguard/{{ vault_wg_interface }}.conf"
    dest: "/etc/wireguard/backups/{{ vault_wg_interface }}.conf.backup.{{ ansible_facts['date_time']['iso8601'] }}"
    remote_src: yes
    mode: '0600'
  when:
    - wg_config_exists.stat.exists
    - wg_operation == "install"
    - not ansible_check_mode
  register: wg_backup
 
- name: Display backup location
  ansible.builtin.debug:
    msg: "Existing config backed up to: {{ wg_backup.dest }}"
  when:
    - wg_backup is defined
    - wg_backup.changed

- name: Compute WireGuard config identity for this host
  ansible.builtin.set_fact:
    wg_config_server_name: >-
      {{
        (
          (
            vault_wg_server_ips | default({}) | dict2items
            | selectattr('key', 'in', group_names | default([]))
            | map(attribute='key')
            | list
            | first
          )
          | default(
              (
                vault_wg_peers | default([])
                | selectattr('is_server', 'defined')
                | selectattr('is_server')
                | selectattr('host_group', 'defined')
                | selectattr('host_group', 'in', group_names | default([]))
                | map(attribute='name')
                | list
                | first
              )
            )
          | default('default')
        )
      }}
  when: wg_operation == "install"

- name: Validate WireGuard private key exists for this host mapping
  ansible.builtin.assert:
    that:
      - vault_wg_peer_private_keys is defined
      - (vault_wg_peer_private_keys[wg_config_server_name] | default(vault_wg_server_private_key)) is not none
      - (vault_wg_peer_private_keys[wg_config_server_name] | default(vault_wg_server_private_key) | string | trim | length) > 0
    fail_msg: >-
      Missing WireGuard private key for host {{ inventory_hostname }}.
      Resolved key name: {{ wg_config_server_name }}.
      Ensure vault_wg_peer_private_keys[{{ wg_config_server_name }}] is set,
      or provide vault_wg_server_private_key fallback.
    success_msg: "WireGuard private key mapping is present"
  when: wg_operation == "install"

- name: Deploy WireGuard server configuration
  ansible.builtin.template:
    src: server.conf.j2
    dest: "/etc/wireguard/{{ vault_wg_interface }}.conf"
    mode: '0600'
    backup: yes
  register: wg_config_deployed
 
- name: Check if WireGuard interface is already running
  ansible.builtin.shell: ip link show {{ vault_wg_interface }} 2>/dev/null
  register: wg_interface_running
  changed_when: false
  failed_when: false
  when:
    - wg_operation == "install"
    - not ansible_check_mode

- name: Enable WireGuard service on boot
  ansible.builtin.systemd:
    name: "wg-quick@{{ vault_wg_interface }}"
    enabled: yes
    daemon_reload: yes
  when: wg_operation == "install"

- name: Compute matching WireGuard server group for this host
  ansible.builtin.set_fact:
    wg_server_group_match: >-
      {{
        (vault_wg_server_ips | default({}) | dict2items
         | selectattr('key', 'in', group_names | default([]))
         | map(attribute='key')
         | list
         | first)
        | default('')
      }}

- name: Compute desired WireGuard interface IP for this host
  ansible.builtin.set_fact:
    wg_desired_interface_ip: >-
      {{
        (vault_wg_server_ips[wg_server_group_match]
         if (wg_server_group_match | length > 0)
         else vault_wg_server_ip)
        | string
      }}
  when: wg_operation == "install"

- name: Get current WireGuard interface IPv4 address
  ansible.builtin.command: ip -4 -o addr show dev {{ vault_wg_interface }}
  register: wg_interface_ipv4_show
  changed_when: false
  failed_when: false
  when:
    - wg_operation == "install"
    - wg_interface_running.rc | default(1) == 0
    - not ansible_check_mode

- name: Detect WireGuard interface address drift
  ansible.builtin.set_fact:
    wg_current_interface_ip: >-
      {{
        (wg_interface_ipv4_show.stdout
         | regex_findall('inet\\s+([0-9.]+)/')
         | first)
        | default('')
      }}
  when:
    - wg_operation == "install"
    - wg_interface_running.rc | default(1) == 0
    - not ansible_check_mode

- name: Set WireGuard interface address drift flag
  ansible.builtin.set_fact:
    wg_interface_address_changed: >-
      {{
        (wg_interface_ipv4_show.rc | default(1) == 0)
        and ((wg_interface_ipv4_show.stdout | default('')) | length > 0)
        and (wg_desired_interface_ip | length > 0)
        and ((wg_current_interface_ip | default('')) != wg_desired_interface_ip)
      }}
  when:
    - wg_operation == "install"
    - wg_interface_running.rc | default(1) == 0
    - not ansible_check_mode

- name: Sync WireGuard configuration without restart (preserves connections)
  ansible.builtin.shell: |
    wg syncconf {{ vault_wg_interface }} <(wg-quick strip {{ vault_wg_interface }})
  args:
    executable: /bin/bash
  register: wg_sync_action
  when:
    - wg_operation == "install"
    - wg_config_deployed.changed
    - wg_interface_running.rc | default(1) == 0
    - not (wg_interface_address_changed | default(false))
    - not ansible_check_mode
  changed_when: true

- name: Validate WireGuard config with wg-quick strip
  ansible.builtin.command: wg-quick strip {{ vault_wg_interface }}
  register: wg_config_parse_check
  changed_when: false
  failed_when: wg_config_parse_check.rc != 0
  when:
    - wg_operation == "install"
    - wg_config_deployed.changed
    - not ansible_check_mode

- name: Restart WireGuard service when interface address changed
  block:
    - name: Restart WireGuard service
      ansible.builtin.systemd:
        name: "wg-quick@{{ vault_wg_interface }}"
        state: restarted
      register: wg_service_action
  rescue:
    - name: Collect WireGuard systemd status after restart failure
      ansible.builtin.command: systemctl --no-pager -l status wg-quick@{{ vault_wg_interface }}
      register: wg_systemd_status
      changed_when: false
      failed_when: false

    - name: Collect WireGuard journal after restart failure
      ansible.builtin.command: journalctl --no-pager -xeu wg-quick@{{ vault_wg_interface }} -n 80
      register: wg_journal_status
      changed_when: false
      failed_when: false

    - name: Fail with WireGuard restart diagnostics
      ansible.builtin.fail:
        msg: |-
          Failed to restart wg-quick@{{ vault_wg_interface }} on {{ inventory_hostname }}.
          systemctl status:
          {{ wg_systemd_status.stdout | default('no output') }}

          journalctl -xeu output:
          {{ wg_journal_status.stdout | default('no output') }}
  when:
    - wg_operation == "install"
    - wg_config_deployed.changed
    - wg_interface_running.rc | default(1) == 0
    - wg_interface_address_changed | default(false)
    - not ansible_check_mode

- name: Start WireGuard service (interface not running)
  block:
    - name: Start WireGuard service
      ansible.builtin.systemd:
        name: "wg-quick@{{ vault_wg_interface }}"
        state: started
      register: wg_service_action
  rescue:
    - name: Collect WireGuard systemd status after startup failure
      ansible.builtin.command: systemctl --no-pager -l status wg-quick@{{ vault_wg_interface }}
      register: wg_systemd_status
      changed_when: false
      failed_when: false

    - name: Collect WireGuard journal after startup failure
      ansible.builtin.command: journalctl --no-pager -xeu wg-quick@{{ vault_wg_interface }} -n 80
      register: wg_journal_status
      changed_when: false
      failed_when: false

    - name: Fail with WireGuard startup diagnostics
      ansible.builtin.fail:
        msg: |-
          Failed to start wg-quick@{{ vault_wg_interface }} on {{ inventory_hostname }}.
          systemctl status:
          {{ wg_systemd_status.stdout | default('no output') }}

          journalctl -xeu output:
          {{ wg_journal_status.stdout | default('no output') }}
  when:
    - wg_operation == "install"
    - wg_interface_running.rc | default(1) != 0
    - not ansible_check_mode
 
- name: Wait for WireGuard interface to come up
  ansible.builtin.shell: ip link show {{ vault_wg_interface }}
  register: wg_interface_check
  changed_when: false
  async: 15
  poll: 2
  until: wg_interface_check.rc == 0
  retries: 5
  delay: 2
  when:
    - wg_operation == "install"
    - not ansible_check_mode
 
- name: Check WireGuard interface status timeout
  ansible.builtin.fail:
    msg: "WireGuard interface {{ vault_wg_interface }} did not come up after 10 seconds (5 retries x 2s delay)"
  when:
    - wg_operation == "install"
    - not ansible_check_mode
    - wg_interface_check.rc != 0
 
- name: Get WireGuard interface status
  ansible.builtin.shell: wg show {{ vault_wg_interface }}
  register: wg_status
  changed_when: false
  async: 30
  poll: 2
  when:
    - wg_operation == "install"
    - not ansible_check_mode
 
- name: Display WireGuard interface status
  ansible.builtin.debug:
    var: wg_status.stdout_lines
  when:
    - wg_operation == "install"
    - not ansible_check_mode
    - wg_status.stdout_lines is defined
