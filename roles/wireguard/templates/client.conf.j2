# WireGuard Client Configuration for {{ peer_config.name }}
# Generated by Ansible - DO NOT EDIT MANUALLY

[Interface]
Address = {{ peer_config.address | default(peer_config.allowed_ips) }}
PrivateKey = {{ peer_private_key }}
{% if peer_config.client_listen_port is defined %}
ListenPort = {{ peer_config.client_listen_port }}
{% else %}
ListenPort = {{ vault_wg_client_default_port }}
{% endif %}
{% if wg_use_dns | default(true) %}
DNS = {{ vault_wg_dns_primary | default(vault_dns_server_primary | default('[dns-server-ip]')) }}
{% endif %}
{% for rule in wg_postup_rules | default([]) %}
PostUp = {{ rule }}
{% endfor %}
{% for rule in wg_predown_rules | default([]) %}
PreDown = {{ rule }}
{% endfor %}

# BEGIN ANSIBLE MANAGED PEERS
{#
  Routing ownership rules (in priority order):
  1. vault_wg_peers_extra_cidrs[server_peer.name] — explicit per-peer extra CIDRs (authoritative)
  2. is_server: true + vault_wg_routed_cidrs — legacy fallback
  No dedup-based ownership: each peer owns exactly what is configured.
#}
{% set current_in_bgp_routers = inventory_hostname in groups.get('bgp_routers', []) %}

{% for server_peer in vault_wg_peers %}
{%   if server_peer.name != peer_config.name %}
{#     Compute base peer IPs #}
{%     set peer_base_ips = server_peer.allowed_ips | default(server_peer.address) | string | replace(' ', '') | split(',') | reject('equalto', '') | unique | list %}

{#     Determine extra CIDRs (explicit takes precedence over legacy is_server) #}
{%     if server_peer.name in (vault_wg_peers_extra_cidrs | default({})) %}
{%       set extra_cidrs = vault_wg_peers_extra_cidrs[server_peer.name] | list %}
{%     elif (server_peer.is_server | default(false) | bool) and (vault_wg_routed_cidrs | default([]) | length > 0) %}
{%       set routed_extra = vault_wg_routed_cidrs | list %}
{%       set peer_in_bgp_routers = (
            server_peer.host_group is defined
            and server_peer.host_group in groups
            and ((groups[server_peer.host_group] | default([])) | intersect(groups.get('bgp_routers', [])) | length > 0)
          ) %}
{%       if current_in_bgp_routers and peer_in_bgp_routers %}
{%         set routed_extra = [] %}
{%       endif %}
{%       set extra_cidrs = routed_extra %}
{%     else %}
{%       set extra_cidrs = [] %}
{%     endif %}

{#     Build candidate AllowedIPs = base + extra, deduplicated #}
{%     set candidate_ips = (peer_base_ips + extra_cidrs) | unique | list %}

{%     if candidate_ips | length > 0 %}
[Peer]
# {{ server_peer.name }} - {{ server_peer.host_group | default('unknown') }}
PublicKey = {{ vault_wg_peer_public_keys[server_peer.name] }}
Endpoint = {{ server_peer.endpoint }}
AllowedIPs = {{ candidate_ips | join(', ') }}
PersistentKeepalive = 25
{%     endif %}
{%   endif %}
{% endfor %}
# END ANSIBLE MANAGED PEERS
