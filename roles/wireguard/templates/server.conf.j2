# WireGuard Server Configuration - {{ vault_wg_interface }}
# Generated by Ansible - DO NOT EDIT MANUALLY
# Last updated: {{ ansible_date_time.iso8601 }}
# DEBUG: inventory_hostname={{ inventory_hostname }}

[Interface]
{% set server_ip = vault_wg_server_ip %}
{% set server_port = vault_wg_server_port %}
{% set server_name = 'default' %}
{% set host_to_group_map = {} %}
{% set groups_list = [] %}

# DEBUG: Show all groups
{% for group_name, hosts in groups.items() %}
{%   set _ = groups_list.append(group_name) %}
{%   if group_name in vault_wg_server_ips %}
{%     for host in hosts %}
{%       set _ = host_to_group_map.update({host: group_name}) %}
{%     endfor %}
{%   endif %}
{% endfor %}
# DEBUG: groups={{ groups_list }}, host_to_group_map={{ host_to_group_map }}

# Check if inventory_hostname in any server group
{% if inventory_hostname in host_to_group_map %}
{%   set matched_group = host_to_group_map[inventory_hostname] %}
{%   set server_ip = vault_wg_server_ips[matched_group] %}
{%   set server_port = vault_wg_server_ports.get(matched_group, vault_wg_server_port) %}
{%   set server_name = matched_group %}
{% endif %}
# DEBUG: matched_group={{ matched_group }}

Address = {{ server_ip }}/{{ vault_wg_network_cidr.split('/')[1] }}
PrivateKey = {{ vault_wg_peer_private_keys[server_name] | default(vault_wg_server_private_key) }}
ListenPort = {{ server_port | default(vault_wg_server_port) }}
# DEBUG: final server_name={{ server_name }}, using key from vault_wg_peer_private_keys[{{ server_name }}]

# BEGIN ANSIBLE MANAGED PEERS
{% for peer in vault_wg_peers %}
{%   if peer.host_group is defined and inventory_hostname not in groups[peer.host_group] | default([]) %}
[Peer]
# {{ peer.name }} - {{ peer.host_group | default('unknown') }}
PublicKey = {{ vault_wg_peer_public_keys[peer.name] }}
AllowedIPs = {{ peer.allowed_ips }}
{%   if peer.endpoint is defined %}
Endpoint = {{ peer.endpoint }}
{%   endif %}
PersistentKeepalive = 25
{%   endif %}
{% endfor %}
# END ANSIBLE MANAGED PEERS
