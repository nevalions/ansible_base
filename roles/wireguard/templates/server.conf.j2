# WireGuard Server Configuration - {{ vault_wg_interface }}
# Generated by Ansible - DO NOT EDIT MANUALLY

[Interface]
{% set server_ip = vault_wg_server_ip %}
{% set server_port = vault_wg_server_port %}
{% set server_name = 'default' %}
{% set host_to_group_map = {} %}
{% set server_peer_name = '' %}

{% for group_name, hosts in groups.items() %}
{%   if group_name in vault_wg_server_ips %}
{%     for host in hosts %}
{%       set _ = host_to_group_map.update({host: group_name}) %}
{%     endfor %}
{%   endif %}
{% endfor %}

{% if inventory_hostname in host_to_group_map %}
{%   set matched_group = host_to_group_map[inventory_hostname] %}
{%   set server_ip = vault_wg_server_ips[matched_group] %}
{%   set server_port = vault_wg_server_ports.get(matched_group, vault_wg_server_port) %}
{%   set server_name = matched_group %}
{% endif %}

{% if server_name == 'default' %}
{%   set server_peer_name = (
      vault_wg_peers | default([])
      | selectattr('is_server', 'defined')
      | selectattr('is_server')
      | selectattr('host_group', 'defined')
      | selectattr('host_group', 'in', group_names | default([]))
      | map(attribute='name')
      | list
      | first
      | default('')
    ) %}
{%   if server_peer_name | length > 0 %}
{%     set server_name = server_peer_name %}
{%   endif %}
{% endif %}

Address = {{ server_ip }}/{{ vault_wg_network_cidr.split('/')[1] }}
PrivateKey = {{ vault_wg_peer_private_keys[server_name] | default(vault_wg_server_private_key) }}
ListenPort = {{ server_port | default(vault_wg_server_port) }}

{% for rule in wg_postup_rules | default([]) %}
PostUp = {{ rule }}
{% endfor %}
{% for rule in wg_predown_rules | default([]) %}
PreDown = {{ rule }}
{% endfor %}

# BEGIN ANSIBLE MANAGED PEERS
{#
  Routing ownership rules (in priority order):
  1. vault_wg_peers_extra_cidrs[peer.name] — explicit per-peer extra CIDRs (authoritative)
  2. is_server: true + vault_wg_routed_cidrs — legacy fallback (only when no explicit entry)
  3. No dedup-based ownership assignment: each peer owns exactly what is configured for it.
     If two peers claim the same CIDR, the first one wins in the kernel (WireGuard limitation).
#}
{% set ns = namespace(all_assigned_cidrs=[]) %}
{% set current_in_bgp_routers = inventory_hostname in groups.get('bgp_routers', []) %}

{% for peer in vault_wg_peers %}
{%   if peer.host_group is defined and inventory_hostname not in groups[peer.host_group] | default([]) %}
{#     Compute base peer IPs #}
{%     set peer_base_ips = peer.allowed_ips | default(peer.address) | string | replace(' ', '') | split(',') | reject('equalto', '') | unique | list %}

{#     Determine extra CIDRs for this peer (explicit takes precedence over legacy is_server) #}
{%     if peer.name in (vault_wg_peers_extra_cidrs | default({})) %}
{#       Explicit mode: use vault_wg_peers_extra_cidrs[peer.name] #}
{%       set extra_cidrs = vault_wg_peers_extra_cidrs[peer.name] | list %}
{%     elif (peer.is_server | default(false) | bool) and (vault_wg_routed_cidrs | default([]) | length > 0) %}
{#       Legacy mode: is_server gets vault_wg_routed_cidrs, skip if peer is BGP-to-BGP #}
{%       set routed_extra = vault_wg_routed_cidrs | list %}
{%       set peer_in_bgp_routers = (
            peer.host_group is defined
            and peer.host_group in groups
            and ((groups[peer.host_group] | default([])) | intersect(groups.get('bgp_routers', [])) | length > 0)
          ) %}
{%       if current_in_bgp_routers and peer_in_bgp_routers %}
{%         set routed_extra = [] %}
{%       endif %}
{%       set extra_cidrs = routed_extra %}
{%     else %}
{%       set extra_cidrs = [] %}
{%     endif %}

{#     Build candidate AllowedIPs = base + extra, deduplicated #}
{%     set candidate_ips = (peer_base_ips + extra_cidrs) | unique | list %}

{%     if candidate_ips | length > 0 %}
[Peer]
# {{ peer.name }} - {{ peer.host_group | default('unknown') }}
PublicKey = {{ vault_wg_peer_public_keys[peer.name] }}
AllowedIPs = {{ candidate_ips | join(', ') }}
{%       if peer.endpoint is defined %}
Endpoint = {{ peer.endpoint }}
{%       endif %}
PersistentKeepalive = 25
{%       set ns.all_assigned_cidrs = (ns.all_assigned_cidrs + candidate_ips) | list %}
{%     endif %}
{%   endif %}
{% endfor %}
# END ANSIBLE MANAGED PEERS
