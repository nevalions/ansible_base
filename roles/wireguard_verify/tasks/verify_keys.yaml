---
- name: Determine server_name (default fallback)
  ansible.builtin.set_fact:
    server_name: 'default'
  when: inventory_hostname in groups.get('wireguard_servers', [])

- name: Match host to WireGuard server group
  ansible.builtin.set_fact:
    server_name: "{{ item }}"
  loop: "{{ vault_wg_server_ips | default({}) | dict2items | map(attribute='key') | list }}"
  when:
    - inventory_hostname in groups.get('wireguard_servers', [])
    - inventory_hostname in groups.get(item, [])
  loop_control:
    loop_var: item

- name: Derive expected public key from group
  ansible.builtin.set_fact:
    vault_wg_server_public_key: "{{ vault_wg_peer_public_keys[server_name] | default(vault_wg_server_public_key) }}"
  when:
    - inventory_hostname in groups.get('wireguard_servers', [])
    - server_name != 'default'
    - vault_wg_peer_public_keys is defined
    - server_name in vault_wg_peer_public_keys

- name: Display server public key
  ansible.builtin.debug:
    msg: "Server public key (truncated): {{ vault_wg_server_public_key[:20] | default('N/A') }}..."
  when:
    - inventory_hostname in groups.get('wireguard_servers', []) 

- name: Display server group mapping
  ansible.builtin.debug:
    msg: "Server {{ inventory_hostname }} mapped to group: {{ server_name }}"
  when:
    - inventory_hostname in groups.get('wireguard_servers', [])

- name: Check server public key presence in config
  ansible.builtin.command: wg show {{ vault_wg_interface }} public-key
  register: server_public_key_check
  changed_when: false
  ignore_errors: true
  when:
    - inventory_hostname in groups.get('wireguard_servers', []) 

- name: Display running server public key
  ansible.builtin.debug:
    msg: "Running public key (truncated): {{ server_public_key_check.stdout[:20] | default('N/A') }}..."
  when:
    - inventory_hostname in groups.get('wireguard_servers', [])
    - server_public_key_check.stdout_lines is defined

- name: Verify server public key matches
  ansible.builtin.assert:
    that:
      - server_public_key_check.stdout == vault_wg_server_public_key
    success_msg: "Server public key matches vault configuration"
    fail_msg: "Server public key mismatch between running config and vault"
  when:
    - inventory_hostname in groups.get('wireguard_servers', [])
    - server_public_key_check.rc == 0
    - vault_wg_server_public_key is defined
  ignore_errors: true

- name: List configured peers
  ansible.builtin.command: wg show {{ vault_wg_interface }} peers
  register: wg_peers_list
  changed_when: false
  ignore_errors: true


- name: Display configured peers
  ansible.builtin.debug:
    msg: "Configured peers on {{ vault_wg_interface }}: {{ wg_peers_list.stdout_lines | default([]) | truncate_keys_in_string }}"
  when: wg_peers_list.stdout_lines is defined

- name: Verify peer public keys are configured
  ansible.builtin.debug:
    msg: "Peer {{ item.name }} public key: {{ ((vault_wg_peer_public_keys[item.name] if vault_wg_peer_public_keys[item.name] is not none else 'N/A') | default('N/A'))[:20] }}..."
  loop: "{{ vault_wg_peers | default([]) }}"
  when:
    - inventory_hostname in groups.get('wireguard_servers', [])
    - vault_wg_peer_public_keys is defined
    - item.name in vault_wg_peer_public_keys

- name: Check peer handshake status
  ansible.builtin.command: wg show {{ vault_wg_interface }} latest-handshakes
  register: wg_handshakes
  changed_when: false
  no_log: true
  ignore_errors: true

- name: Display peer handshake status
  ansible.builtin.debug:
    msg: "{{ wg_handshakes.stdout | wg_truncate_key }}"
  when: wg_handshakes.stdout is defined

- name: Check peer transfer statistics
  ansible.builtin.command: wg show {{ vault_wg_interface }} transfer
  register: wg_transfer
  changed_when: false
  no_log: true
  ignore_errors: true

- name: Display peer transfer statistics
  ansible.builtin.debug:
    msg: "{{ wg_transfer.stdout | wg_truncate_key }}"
  when: wg_transfer.stdout is defined
