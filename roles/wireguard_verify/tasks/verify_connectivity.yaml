---
- name: Initialize connectivity tests failed counter
  ansible.builtin.set_fact:
    connectivity_tests_failed: 0

- name: Get local WireGuard interface IPv4 address
  ansible.builtin.command: ip -4 -o addr show dev {{ vault_wg_interface }}
  register: wg_local_ip_raw
  changed_when: false
  failed_when: false

- name: Extract local WireGuard IP
  ansible.builtin.set_fact:
    wg_local_ip: "{{ (wg_local_ip_raw.stdout | regex_findall('inet\\s+([0-9.]+)') | first) | default('') }}"

- name: Get runtime WireGuard allowed IPs
  ansible.builtin.command: wg show {{ vault_wg_interface }} allowed-ips
  register: wg_allowed_ips_raw
  changed_when: false
  failed_when: false

- name: Build ping targets from runtime /32 routes
  ansible.builtin.set_fact:
    wg_ping_targets: >-
      {{
        (wg_allowed_ips_raw.stdout | default(''))
        | regex_findall('([0-9]+(?:\\.[0-9]+){3})/32')
        | difference([wg_local_ip])
        | unique
        | list
      }}

- name: Display runtime ping targets
  ansible.builtin.debug:
    msg: "Runtime reachable targets via {{ vault_wg_interface }}: {{ wg_ping_targets | join(', ') if wg_ping_targets | length > 0 else 'none' }}"

- name: Ping runtime WireGuard targets
  ansible.builtin.command: ping -c {{ verify_ping_count }} {{ item }}
  register: ping_peer_result
  changed_when: false
  ignore_errors: true
  loop: "{{ wg_ping_targets | default([]) }}"

- name: Display peer ping results
  ansible.builtin.debug:
    msg: "{{ (('PING SUCCESS' if item.rc == 0 else 'PING FAILED') ~ ': ' ~ item.item) | sanitize_security }}"
  loop: "{{ ping_peer_result.results | default([]) | selectattr('rc', 'defined') | list }}"

- name: Count failed peer pings
  ansible.builtin.set_fact:
    connectivity_tests_failed: "{{ connectivity_tests_failed | int + 1 }}"
  loop: "{{ ping_peer_result.results | default([]) | selectattr('rc', 'defined') | selectattr('rc', 'ne', 0) | list }}"

- name: Calculate total connectivity tests
  ansible.builtin.set_fact:
    total_connectivity_tests: "{{ ping_peer_result.results | default([]) | selectattr('rc', 'defined') | list | length }}"

- name: Display total connectivity test results
  ansible.builtin.debug:
    msg: "Connectivity tests: {{ total_connectivity_tests }} total, {{ connectivity_tests_failed }} failed"
