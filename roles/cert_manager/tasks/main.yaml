---
- name: Skip when cert-manager disabled
  ansible.builtin.meta: end_play
  when: not (cert_manager_enabled | bool)

- name: Compute kubectl/helm delegate host
  ansible.builtin.set_fact:
    cert_manager_kubectl_delegate: "{{ ansible_play_hosts | first }}"
  run_once: true

- name: Fail if cert-manager operation is invalid
  ansible.builtin.assert:
    that:
      - cert_manager_operation in ['install', 'verify', 'remove']
    fail_msg: "cert_manager_operation must be 'install', 'verify', or 'remove'"
    success_msg: "cert-manager operation is valid: {{ cert_manager_operation }}"

- name: Check Helm binary exists
  ansible.builtin.stat:
    path: "{{ cert_manager_helm_binary_path }}"
  register: cert_manager_helm_stat
  run_once: true
  delegate_to: "{{ cert_manager_kubectl_delegate }}"

- name: Assert Helm is installed (required for cert-manager role)
  ansible.builtin.assert:
    that:
      - cert_manager_helm_stat.stat.exists
    fail_msg: "Helm binary not found at {{ cert_manager_helm_binary_path }}. Run kuber_helm_install.yaml first."
    success_msg: "Helm binary found at {{ cert_manager_helm_binary_path }}"
  run_once: true
  delegate_to: "{{ cert_manager_kubectl_delegate }}"

- name: Verify cert-manager when operation is verify
  block:
    - name: Check cert-manager namespace exists
      ansible.builtin.command: kubectl get ns {{ cert_manager_namespace }}
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      register: cert_manager_ns_check
      changed_when: false
      failed_when: false

    - name: Display namespace status
      ansible.builtin.debug:
        msg: "cert-manager namespace {{ cert_manager_namespace }} {{ 'exists' if cert_manager_ns_check.rc == 0 else 'does NOT exist' }}"

    - name: Get cert-manager pods
      ansible.builtin.command: kubectl -n {{ cert_manager_namespace }} get pods -o wide
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      register: cert_manager_pods
      changed_when: false
      failed_when: false
      when: cert_manager_ns_check.rc == 0

    - name: Display cert-manager pods
      ansible.builtin.debug:
        msg: "{{ cert_manager_pods.stdout_lines | default([]) }}"
      when: cert_manager_ns_check.rc == 0

    - name: Check ClusterIssuer staging exists
      ansible.builtin.command: kubectl get clusterissuer {{ cert_manager_clusterissuer_staging_name }}
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      register: cert_manager_issuer_check
      changed_when: false
      failed_when: false
      when: cert_manager_clusterissuer_staging_enabled | bool

    - name: Check ClusterIssuer production exists
      ansible.builtin.command: kubectl get clusterissuer {{ cert_manager_clusterissuer_prod_name }}
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      register: cert_manager_issuer_prod_check
      changed_when: false
      failed_when: false
      when: cert_manager_clusterissuer_prod_enabled | bool

    - name: Display ClusterIssuer status (wide)
      ansible.builtin.command: kubectl get clusterissuer {{ cert_manager_clusterissuer_staging_name }} -o wide
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      register: cert_manager_issuer_wide
      changed_when: false
      failed_when: false
      when:
        - cert_manager_clusterissuer_staging_enabled | bool
        - cert_manager_issuer_check.rc == 0

    - name: Display ClusterIssuer
      ansible.builtin.debug:
        msg: "{{ cert_manager_issuer_wide.stdout_lines | default([]) }}"
      when:
        - cert_manager_clusterissuer_staging_enabled | bool
        - cert_manager_issuer_check.rc == 0
  run_once: true
  delegate_to: "{{ cert_manager_kubectl_delegate }}"
  when: cert_manager_operation == 'verify'

- name: End play after verification
  ansible.builtin.meta: end_play
  when: cert_manager_operation == 'verify'

- name: Remove cert-manager when operation is remove
  block:
    - name: Delete ClusterIssuer staging (best-effort)
      ansible.builtin.command: kubectl delete clusterissuer {{ cert_manager_clusterissuer_staging_name }} --ignore-not-found
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      register: cert_manager_issuer_delete
      changed_when: false
      failed_when: false
      when: cert_manager_clusterissuer_staging_enabled | bool

    - name: Delete ClusterIssuer production (best-effort)
      ansible.builtin.command: kubectl delete clusterissuer {{ cert_manager_clusterissuer_prod_name }} --ignore-not-found
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      register: cert_manager_issuer_prod_delete
      changed_when: false
      failed_when: false
      when: cert_manager_clusterissuer_prod_enabled | bool

    - name: Uninstall cert-manager release (best-effort)
      ansible.builtin.command: >-
        {{ cert_manager_helm_binary_path }} uninstall {{ cert_manager_release_name }}
        --namespace {{ cert_manager_namespace }}
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      register: cert_manager_uninstall
      changed_when: cert_manager_uninstall.rc == 0
      failed_when: false

    - name: Optionally delete cert-manager namespace
      ansible.builtin.command: kubectl delete ns {{ cert_manager_namespace }} --ignore-not-found
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      register: cert_manager_ns_delete
      changed_when: false
      failed_when: false
      when: cert_manager_remove_namespace | bool
  run_once: true
  delegate_to: "{{ cert_manager_kubectl_delegate }}"
  when: cert_manager_operation == 'remove'

- name: End play after removal
  ansible.builtin.meta: end_play
  when: cert_manager_operation == 'remove'

- name: Install cert-manager when operation is install
  block:
    - name: Fail if ACME email is invalid (staging ClusterIssuer)
      ansible.builtin.assert:
        that:
          - cert_manager_acme_email is defined
          - cert_manager_acme_email is string
          - (cert_manager_acme_email | trim) | length > 0
          - cert_manager_acme_email is not match('^\[.*\]$')
          - (cert_manager_acme_email | trim) is search('@')
        fail_msg: >-
          cert_manager_acme_email must be a single email string (not a list), e.g.
          vault_cert_manager_acme_email: "[your-email]" (replace placeholder with a real email)
        success_msg: "ACME email looks valid"
      when: cert_manager_clusterissuer_staging_enabled | bool

    - name: Add Jetstack Helm repo
      ansible.builtin.command: >-
        {{ cert_manager_helm_binary_path }} repo add jetstack https://charts.jetstack.io --force-update
      register: cert_manager_repo_add
      changed_when: "'has been added' in cert_manager_repo_add.stdout or 'updated' in cert_manager_repo_add.stdout"

    - name: Update Helm repos
      ansible.builtin.command: "{{ cert_manager_helm_binary_path }} repo update"
      register: cert_manager_repo_update
      changed_when: false

    - name: Install/upgrade cert-manager via Helm
      ansible.builtin.command: >-
        {{ cert_manager_helm_binary_path }} upgrade --install {{ cert_manager_release_name }} {{ cert_manager_chart_ref }}
        --namespace {{ cert_manager_namespace }}
        --create-namespace
        --set crds.enabled={{ (cert_manager_crds_enabled | bool) | lower }}
        --set crds.keep={{ (cert_manager_crds_keep | bool) | lower }}
        {% if cert_manager_chart_version | default('') | length > 0 %}--version {{ cert_manager_chart_version }}{% endif %}
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      register: cert_manager_helm_install
      changed_when: "'deployed' in cert_manager_helm_install.stdout or 'upgraded' in cert_manager_helm_install.stdout"

    - name: Wait for cert-manager deployments rollout
      ansible.builtin.command: kubectl -n {{ cert_manager_namespace }} rollout status deploy/{{ item }} --timeout=300s
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      register: cert_manager_rollout
      changed_when: false
      retries: 10
      delay: 10
      until: cert_manager_rollout.rc == 0
      loop:
        - cert-manager
        - cert-manager-cainjector
        - cert-manager-webhook

    - name: Render ClusterIssuer (Let's Encrypt staging)
      ansible.builtin.template:
        src: clusterissuer-staging.yaml.j2
        dest: /tmp/cert-manager-clusterissuer-staging.yaml
        mode: "0644"
      when: cert_manager_clusterissuer_staging_enabled | bool

    - name: Render ClusterIssuer (Let's Encrypt production)
      ansible.builtin.template:
        src: clusterissuer-prod.yaml.j2
        dest: /tmp/cert-manager-clusterissuer-prod.yaml
        mode: "0644"
      when: cert_manager_clusterissuer_prod_enabled | bool

    - name: Apply ClusterIssuer (Let's Encrypt staging)
      ansible.builtin.command: kubectl apply -f /tmp/cert-manager-clusterissuer-staging.yaml
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      register: cert_manager_issuer_apply
      changed_when: "'created' in cert_manager_issuer_apply.stdout or 'configured' in cert_manager_issuer_apply.stdout"
      when: cert_manager_clusterissuer_staging_enabled | bool

    - name: Apply ClusterIssuer (Let's Encrypt production)
      ansible.builtin.command: kubectl apply -f /tmp/cert-manager-clusterissuer-prod.yaml
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      register: cert_manager_issuer_prod_apply
      changed_when: "'created' in cert_manager_issuer_prod_apply.stdout or 'configured' in cert_manager_issuer_prod_apply.stdout"
      when: cert_manager_clusterissuer_prod_enabled | bool

    - name: Wait for ClusterIssuer staging to be Ready
      ansible.builtin.command: >-
        kubectl get clusterissuer {{ cert_manager_clusterissuer_staging_name }}
        -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}'
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      register: cert_manager_issuer_ready
      changed_when: false
      retries: 60
      delay: 5
      until: (cert_manager_issuer_ready.stdout | default('') | trim) == 'True'
      when:
        - cert_manager_clusterissuer_staging_enabled | bool
        - cert_manager_wait_for_clusterissuer_ready | bool
  run_once: true
  delegate_to: "{{ cert_manager_kubectl_delegate }}"
  when: cert_manager_operation == 'install'
