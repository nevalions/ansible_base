---
- name: Check if Kubernetes configuration exists
  ansible.builtin.stat:
    path: "{{ item }}"
  register: k8s_config_exists
  loop:
    - /etc/kubernetes/admin.conf
    - /etc/kubernetes/kubelet.conf
  failed_when: false

- name: Display Kubernetes configuration status
  ansible.builtin.debug:
    msg:
      - "=== Kubernetes Reset Start ==="
      - "Kubernetes admin.conf exists: {{ k8s_config_exists.results[0].stat.exists }}"
      - "Kubernetes kubelet.conf exists: {{ k8s_config_exists.results[1].stat.exists }}"

- name: Check if Kubernetes packages are installed
  ansible.builtin.apt:
    name:
      - kubelet
      - kubeadm
      - kubectl
    state: absent
  check_mode: yes
  register: k8s_packages_installed
  changed_when: false
  failed_when: false

- name: Unhold Kubernetes packages
  ansible.builtin.dpkg_selections:
    name: "{{ item }}"
    selection: install
  loop:
    - kubelet
    - kubeadm
    - kubectl
  failed_when: false

- name: Remove Kubernetes packages
  ansible.builtin.apt:
    name:
      - kubelet
      - kubeadm
      - kubectl
    state: absent
    purge: yes
    autoremove: yes
  register: pkg_removal
  failed_when: false

- name: Stop kubelet service
  ansible.builtin.systemd:
    name: kubelet
    state: stopped
  failed_when: false
  notify: restart kubelet

- name: Stop containerd service
  ansible.builtin.systemd:
    name: containerd
    state: stopped
  failed_when: false
  notify: restart containerd

- name: Check if kubeadm reset is available
  ansible.builtin.command: which kubeadm
  register: kubeadm_check
  changed_when: false
  failed_when: false

- name: Run kubeadm reset to clean cluster configuration
  ansible.builtin.command: kubeadm reset --force
  when: kubeadm_check.rc == 0
  failed_when: false
  register: kubeadm_reset
  changed_when: kubeadm_reset.rc == 0

- name: Stop CNI-related services
  ansible.builtin.shell: |
    systemctl stop cni* 2>/dev/null || true
    pkill -9 -f cni 2>/dev/null || true
  failed_when: false
  changed_when: false

- name: Force remove CNI directory contents
  ansible.builtin.shell: |
    rm -rf /etc/cni/net.d/* 2>/dev/null || true
    rm -rf /opt/cni/bin/* 2>/dev/null || true
    rm -rf /var/lib/cni/* 2>/dev/null || true
  failed_when: false
  changed_when: false

- name: Remove CNI plugins and configurations
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/cni/net.d
    - /opt/cni/bin
    - /var/lib/cni

- name: Remove Calico network interfaces
  ansible.builtin.shell: |
    set -e -o pipefail
    ip link show | grep -E "cali|tunl|flannel" | awk '{print $2}' | cut -d':' -f1 | xargs -r -I {} ip link delete {} type dummy
  failed_when: false
  changed_when: false

- name: Remove all Docker/Containerd containers
  ansible.builtin.shell: |
    set -e -o pipefail
    if command -v crictl &> /dev/null; then
      crictl ps -q | xargs -r crictl stop
      crictl ps -aq | xargs -r crictl rm
    fi
  failed_when: false
  changed_when: false
  register: container_cleanup

- name: Remove all container images (if configured)
  ansible.builtin.shell: |
    set -e -o pipefail
    if command -v crictl &> /dev/null; then
      crictl images -q | xargs -r crictl rmi
    fi
  when: remove_container_images | default(false)
  failed_when: false
  changed_when: false
  register: image_cleanup

- name: Clean Kubernetes data directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/kubernetes
    - /var/lib/kubelet
    - /var/lib/dockershim
    - /var/run/kubernetes
    - /var/lib/etcd

- name: Clean containerd data
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /var/lib/containerd
    - /etc/containerd

- name: Flush iptables rules
  ansible.builtin.shell: |
    iptables -F
    iptables -t nat -F
    iptables -t mangle -F
    iptables -X
    iptables -t nat -X
    iptables -t mangle -X
    iptables -P INPUT ACCEPT
    iptables -P FORWARD ACCEPT
    iptables -P OUTPUT ACCEPT
  failed_when: false
  changed_when: false

- name: Flush ip6tables rules
  ansible.builtin.shell: |
    ip6tables -F
    ip6tables -t nat -F
    ip6tables -t mangle -F
    ip6tables -X
    ip6tables -t nat -X
    ip6tables -t mangle -X
    ip6tables -P INPUT ACCEPT
    ip6tables -P FORWARD ACCEPT
    ip6tables -P OUTPUT ACCEPT
  failed_when: false
  changed_when: false

- name: Clean kube-proxy iptables rules
  ansible.builtin.shell: |
    set -e -o pipefail
    iptables-save | grep -v KUBE | grep -v CNI | iptables-restore
  failed_when: false
  changed_when: false

- name: Stop CNI network namespace systemd units
  ansible.builtin.shell: |
    set -e -o pipefail
    systemctl list-units --all --type=mount | grep 'run-netns-cni' | awk '{print $1}' | xargs -r systemctl stop
  failed_when: false
  changed_when: false
  register: cni_systemd_stop

- name: Unmount CNI network namespace mounts
  ansible.builtin.shell: |
    set -e -o pipefail
    mount | grep '/run/netns/cni' | awk '{print $3}' | xargs -r -n1 umount -l
  failed_when: false
  changed_when: false
  register: cni_netns_unmount

- name: Remove CNI network namespace directories after unmount
  ansible.builtin.shell: |
    set -e -o pipefail
    rm -rf /run/netns/cni-* 2>/dev/null || true
  failed_when: false
  changed_when: false
  register: cni_netns_dirs

- name: Remove CNI network namespaces
  ansible.builtin.shell: |
    set -e -o pipefail
    ip netns list 2>/dev/null | grep cni | xargs -r -I {} ip netns delete {}
  failed_when: false
  changed_when: false
  register: cni_netns_delete

- name: Check for orphaned CNI network namespace mounts
  ansible.builtin.shell: |
    systemctl list-units --all --type=mount | grep 'run-netns-cni' | wc -l
  failed_when: false
  changed_when: false
  register: orphaned_netns_count

- name: Warn about orphaned network namespaces
  ansible.builtin.debug:
    msg:
      - "=== WARNING: Orphaned CNI Network Namespaces Detected ==="
      - "Found {{ orphaned_netns_count.stdout | int }} orphaned network namespace mount(s)"
      - "These orphaned nsfs mounts are systemd mount units that persist despite cleanup"
      - "They DO NOT interfere with Kubernetes operation or reinitialization"
      - "To remove them completely, reboot the node:"
      - "  sudo reboot"
      - "Reference: kubeadm reset is 'best-effort' cleanup - Kubernetes docs recommend manual intervention or reboot for persistent network namespace mounts"
  when: orphaned_netns_count.stdout | int > 0

- name: Clean any remaining Calico data
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /var/lib/calico
    - /run/calico

- name: Reload systemd daemon
  ansible.builtin.systemd:
    daemon_reload: true
  notify: reload systemd

- name: Verify CNI directories are removed (before containerd starts)
  ansible.builtin.stat:
    path: "{{ item }}"
  register: cni_dirs_removed
  failed_when: false
  loop:
    - /etc/cni/net.d
    - /opt/cni/bin
    - /var/lib/cni

- name: Assert CNI directories are removed
  ansible.builtin.assert:
    that:
      - not item.stat.exists
    success_msg: "{{ item.item }} removed successfully"
    fail_msg: "{{ item.item }} still exists after reset"
  loop: "{{ cni_dirs_removed.results }}"

- name: Start containerd service
  ansible.builtin.systemd:
    name: containerd
    state: started
    enabled: true
  notify: restart containerd

- name: Verify Kubernetes directories are removed
  ansible.builtin.stat:
    path: "{{ item }}"
  register: k8s_dirs_removed
  failed_when: false
  loop:
    - /etc/kubernetes
    - /var/lib/kubelet
    - /var/lib/etcd

- name: Verify Calico directories are removed
  ansible.builtin.stat:
    path: "{{ item }}"
  register: calico_dirs_removed
  failed_when: false
  loop:
    - /var/lib/calico
    - /run/calico

- name: Verify CNI directories are removed
  ansible.builtin.stat:
    path: "{{ item }}"
  register: cni_dirs_removed
  failed_when: false
  loop:
    - /etc/cni/net.d
    - /opt/cni/bin
    - /var/lib/cni

- name: Assert Kubernetes directories are removed
  ansible.builtin.assert:
    that:
      - not item.stat.exists
    success_msg: "{{ item.item }} removed successfully"
    fail_msg: "{{ item.item }} still exists after reset"
  loop: "{{ k8s_dirs_removed.results }}"

- name: Assert Calico directories are removed
  ansible.builtin.assert:
    that:
      - not item.stat.exists
    success_msg: "{{ item.item }} removed successfully"
    fail_msg: "{{ item.item }} still exists after reset"
  loop: "{{ calico_dirs_removed.results }}"

- name: Display CNI recreation note
  ansible.builtin.debug:
    msg: "NOTE: Containerd may recreate empty /etc/cni/net.d directory on startup - this is expected behavior"

- name: Verify kubelet is running
  ansible.builtin.systemd:
    name: kubelet
  register: kubelet_running
  failed_when: false

- name: Verify containerd is running
  ansible.builtin.systemd:
    name: containerd
  register: containerd_running
  failed_when: false

- name: Display reset completion message
  ansible.builtin.debug:
    msg:
      - "=== Kubernetes Reset Complete ==="
      - "Kubernetes directories: Removed"
      - "Calico directories: Removed"
      - "CNI directories: Verified removed (before containerd start)"
      - "CNI network namespaces: {{ 'Cleaned' if orphaned_netns_count.stdout | int == 0 else 'Warning - see above' }}"
      - "Kubelet status: {{ 'Running' if kubelet_running.status.ActiveState == 'active' else 'Not running' }}"
      - "Containerd status: {{ 'Running' if containerd_running.status.ActiveState == 'active' else 'Not running' }}"
      - "Container images: {{ 'Removed' if remove_container_images | default(false) else 'Preserved' }}"
      - "Note: Containerd recreates /etc/cni/net.d on startup (expected)"
      - "Next step: Run kuber_plane_init.yaml or kuber_worker_join.yaml"
