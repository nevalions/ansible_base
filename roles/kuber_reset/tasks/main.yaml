---
- name: Stop kubelet service
  ansible.builtin.systemd:
    name: kubelet
    state: stopped
  ignore_errors: true

- name: Stop containerd service
  ansible.builtin.systemd:
    name: containerd
    state: stopped
  ignore_errors: true

- name: Check if kubeadm reset is available
  ansible.builtin.command: which kubeadm
  register: kubeadm_check
  changed_when: false
  failed_when: false

- name: Run kubeadm reset to clean cluster configuration
  ansible.builtin.command: kubeadm reset --force
  when: kubeadm_check.rc == 0
  ignore_errors: true
  register: kubeadm_reset

- name: Remove CNI plugins and configurations
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/cni/net.d
    - /opt/cni/bin
    - /var/lib/cni

- name: Remove Calico network interfaces
  ansible.builtin.shell: |
    ip link show | grep -E "cali|tunl|flannel" | awk '{print $2}' | cut -d':' -f1 | xargs -r -I {} ip link delete {} type dummy
  ignore_errors: true
  changed_when: false

- name: Remove all Docker/Containerd containers
  ansible.builtin.shell: |
    if command -v crictl &> /dev/null; then
      crictl ps -q | xargs -r crictl stop
      crictl ps -aq | xargs -r crictl rm
    fi
  ignore_errors: true
  changed_when: false
  register: container_cleanup

- name: Remove all container images (if configured)
  ansible.builtin.shell: |
    if command -v crictl &> /dev/null; then
      crictl images -q | xargs -r crictl rmi
    fi
  when: remove_container_images | default(false)
  ignore_errors: true
  changed_when: false
  register: image_cleanup

- name: Clean Kubernetes data directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/kubernetes
    - /var/lib/kubelet
    - /var/lib/dockershim
    - /var/run/kubernetes
    - /var/lib/etcd

- name: Clean containerd data
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /var/lib/containerd
    - /etc/containerd

- name: Flush iptables rules
  ansible.builtin.shell: |
    iptables -F
    iptables -t nat -F
    iptables -t mangle -F
    iptables -X
    iptables -t nat -X
    iptables -t mangle -X
    iptables -P INPUT ACCEPT
    iptables -P FORWARD ACCEPT
    iptables -P OUTPUT ACCEPT
  ignore_errors: true
  changed_when: false

- name: Flush ip6tables rules
  ansible.builtin.shell: |
    ip6tables -F
    ip6tables -t nat -F
    ip6tables -t mangle -F
    ip6tables -X
    ip6tables -t nat -X
    ip6tables -t mangle -X
    ip6tables -P INPUT ACCEPT
    ip6tables -P FORWARD ACCEPT
    ip6tables -P OUTPUT ACCEPT
  ignore_errors: true
  changed_when: false

- name: Clean kube-proxy iptables rules
  ansible.builtin.shell: |
    iptables-save | grep -v KUBE | grep -v CNI | iptables-restore
  ignore_errors: true
  changed_when: false

- name: Remove Kubernetes network namespaces
  ansible.builtin.shell: |
    ip netns list 2>/dev/null | grep -E 'cni|k8s' | xargs -r -I {} ip netns delete {}
  ignore_errors: true
  changed_when: false

- name: Clean any remaining Calico data
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /var/lib/calico
    - /run/calico

- name: Reload systemd daemon
  ansible.builtin.systemd:
    daemon_reload: yes

- name: Start containerd service
  ansible.builtin.systemd:
    name: containerd
    state: started
    enabled: true

- name: Display reset completion message
  ansible.builtin.debug:
    msg: |
      Kubernetes worker node has been completely reset.
      The node is now ready for a fresh 'kubeadm join' operation.
      Containerd has been restarted.
      {% if remove_container_images | default(false) %}
      All container images have been removed.
      {% else %}
      Container images have been preserved.
      {% endif %}
