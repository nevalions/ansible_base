---
- name: Get all worker node names
  ansible.builtin.command: kubectl get nodes -l '!node-role.kubernetes.io/control-plane' -o jsonpath='{.items[*].metadata.name}'
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  register: worker_node_names
  changed_when: false

- name: Display worker nodes
  ansible.builtin.debug:
    msg: "{{ worker_node_names.stdout.split() }}"

- name: Get worker node count
  ansible.builtin.set_fact:
    worker_node_count: "{{ worker_node_names.stdout.split() | length if worker_node_names.stdout is defined and worker_node_names.stdout | length > 0 else 0 }}"

- name: Assert workers are joined
  ansible.builtin.assert:
    that:
      - worker_node_count | int > 0
    success_msg: "{{ worker_node_count }} worker node(s) are joined"
    fail_msg: "No worker nodes are joined to the cluster"
  when: worker_node_count is defined

- name: Check if all worker nodes are Ready
  ansible.builtin.command: kubectl get nodes -l '!node-role.kubernetes.io/control-plane' -o jsonpath='{.items[*].status.conditions[?(@.type=="Ready")].status}'
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  register: workers_ready
  changed_when: false
  ignore_errors: true

- name: Display worker readiness status
  ansible.builtin.debug:
    msg: "{{ workers_ready.stdout_lines }}"
  when: workers_ready.stdout is defined

- name: Assert all worker nodes are Ready
  ansible.builtin.assert:
    that:
      - "'False' not in workers_ready.stdout"
    success_msg: "All worker nodes are Ready"
    fail_msg: "Some worker nodes are not Ready"
  when: workers_ready.stdout is defined and workers_ready.stdout | length > 0

- name: Set CNI daemonset namespace and selector for worker checks
  ansible.builtin.set_fact:
    verify_cni_namespace: "{{ 'kube-flannel' if cni_type == 'flannel' else 'calico-system' if cni_type == 'calico' else '' }}"
    verify_cni_label_selector: "{{ 'app=flannel' if cni_type == 'flannel' else 'k8s-app=calico-node' if cni_type == 'calico' else '' }}"

- name: Get total cluster node count
  ansible.builtin.command: kubectl get nodes -o jsonpath='{.items[*].metadata.name}'
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  register: cluster_node_names
  changed_when: false

- name: Set total cluster node count fact
  ansible.builtin.set_fact:
    cluster_node_count: "{{ cluster_node_names.stdout.split() | length if cluster_node_names.stdout is defined and cluster_node_names.stdout | length > 0 else 0 }}"

- name: Get CNI daemonset pods on all nodes
  ansible.builtin.command: >-
    kubectl get pods -n {{ verify_cni_namespace }}
    -l {{ verify_cni_label_selector }} -o wide
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  register: verify_cni_pods_wide
  changed_when: false
  when:
    - cni_type in ['flannel', 'calico']

- name: Display CNI daemonset pods distribution
  ansible.builtin.debug:
    var: verify_cni_pods_wide.stdout_lines
  when:
    - cni_type in ['flannel', 'calico']

- name: Count CNI daemonset pods
  ansible.builtin.set_fact:
    verify_cni_pod_count: "{{ verify_cni_pods_wide.stdout_lines[1:] | length if verify_cni_pods_wide.stdout_lines is defined and verify_cni_pods_wide.stdout_lines | length > 1 else 0 }}"
  when:
    - cni_type in ['flannel', 'calico']

- name: Verify CNI daemonset pods match cluster nodes
  ansible.builtin.assert:
    that:
      - verify_cni_pod_count | int == cluster_node_count | int
    success_msg: "{{ cni_type | upper }} daemon pods ({{ verify_cni_pod_count }}) match cluster nodes ({{ cluster_node_count }})"
    fail_msg: "{{ cni_type | upper }} daemon pods ({{ verify_cni_pod_count }}) do not match cluster nodes ({{ cluster_node_count }})"
  when:
    - cni_type in ['flannel', 'calico']

- name: Skip CNI daemonset node-match check for unknown CNI type
  ansible.builtin.debug:
    msg: "Skipping CNI daemonset count verification because CNI type is '{{ cni_type | default('unknown') }}'"
  when:
    - cni_type not in ['flannel', 'calico']

- name: Get node details for each worker
  ansible.builtin.command: kubectl describe node {{ item }}
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  register: node_details
  changed_when: false
  loop: "{{ worker_node_names.stdout.split() }}"
  when: worker_node_names.stdout is defined
  ignore_errors: true
