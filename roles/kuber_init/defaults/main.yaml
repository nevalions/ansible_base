---
# Kubernetes Network Configuration (from vault)
kubeadm_pod_subnet: "{{ vault_k8s_pod_subnet }}"
kubeadm_service_subnet: "{{ vault_k8s_service_subnet }}"

# Use VIP as control plane endpoint for worker joins
kubeadm_control_plane_endpoint: "{{ vault_k8s_api_vip }}:{{ vault_k8s_api_port }}"

# Advertise WireGuard IP for internal communication
# Dynamically finds current host's IP from vault_k8s_control_planes list
# Falls back to ansible_default_ipv4.address if not found
kubeadm_api_server_advertise_address: >-
  {{
    (vault_k8s_control_planes
      | selectattr('name', 'equalto', inventory_hostname)
      | map(attribute='wireguard_ip')
      | list
      | first)
    | default(
        ansible_facts.get(vault_keepalived_vip_interface | default('wg99'), {}).get('ipv4', {}).get('address', '')
      )
    | default(ansible_default_ipv4.address)
  }}

kubeadm_kubelet_extra_args:
  node-ip: "{{ kubeadm_api_server_advertise_address }}"

kubeadm_api_version: "v1beta4"

# Calico CNI Configuration (from vault with sensible defaults)
calico_version: "{{ vault_calico_version | default('v3.31.3') }}"
calico_tigera_operator_url: "https://raw.githubusercontent.com/projectcalico/calico/{{ calico_version }}/manifests/tigera-operator.yaml"

# Calico IP Pool Configuration
# Uses pod subnet from kubeadm configuration for consistency
calico_ippool_name: "{{ vault_calico_ippool_name | default('default-ipv4-ippool') }}"
calico_ippool_cidr: "{{ kubeadm_pod_subnet }}"
calico_encapsulation: "{{ vault_calico_encapsulation | default('VXLANCrossSubnet') }}"
calico_nat_outgoing: "{{ vault_calico_nat_outgoing | default(true) }}"
calico_node_selector: "{{ vault_calico_node_selector | default('all()') }}"
calico_block_size: "{{ vault_calico_block_size | default(26) }}"
calico_mtu: "{{ vault_calico_mtu | default(1440) }}"
calico_node_address_interface: "{{ vault_interface | default('wg99') }}"

# Kubeconfig Configuration
kubeconfig_user: "{{ vault_admin_user | default(ansible_user | default(ansible_user_id)) }}"
kubeconfig_user_home: "{{ ansible_env.HOME | default(ansible_user_dir | default('/home/' ~ kubeconfig_user)) }}"
kubeconfig_path: "{{ kubeconfig_user_home }}/.kube/config"
