---
# Calico Installation Custom Resources
# Generated by Ansible - Do not edit manually
# This file configures the Tigera operator to deploy Calico CNI
#
# IMPORTANT for WireGuard + Calico IPIP deployments:
# - natOutgoing MUST be Enabled for pods to reach node IPs (WireGuard addresses)
# - typhaDeployment anti-affinity prevents port 5473 conflicts on same node
# - MTU should be ~1380 for WireGuard (1420 WG - 20 IPIP - 20 overhead)

apiVersion: operator.tigera.io/v1
kind: Installation
metadata:
  name: default
spec:
  # Control plane replicas (typha instances)
  # For small clusters (< 5 nodes), 1 replica is sufficient
  # The typha autoscaler may override this; anti-affinity below prevents conflicts
  controlPlaneReplicas: {{ calico_typha_replicas | default(1) }}

  # Typha deployment configuration with required anti-affinity
  # This prevents multiple typha pods on the same node (port 5473 conflict)
  typhaDeployment:
    spec:
      template:
        spec:
          affinity:
            podAntiAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                - labelSelector:
                    matchLabels:
                      k8s-app: calico-typha
                  topologyKey: kubernetes.io/hostname

  calicoNetwork:
    mtu: {{ calico_mtu }}
    nodeAddressAutodetectionV4:
      interface: "{{ calico_node_address_interface }}"
    ipPools:
    - name: {{ calico_ippool_name }}
      cidr: {{ calico_ippool_cidr }}
      encapsulation: {{ calico_encapsulation }}
      natOutgoing: {{ 'Enabled' if (calico_nat_outgoing | bool) else 'Disabled' }}
      nodeSelector: {{ calico_node_selector }}
      blockSize: {{ calico_block_size }}
