---
- name: Ensure keepalived is installed
  ansible.builtin.apt:
    name:
      - keepalived
      - iptables-persistent
    state: present
    update_cache: true

- name: Determine active control plane (for iptables DNAT)
  ansible.builtin.set_fact:
    keepalived_active_plane: "{{ keepalived_control_planes[0] }}"
  when: keepalived_control_planes is defined and keepalived_control_planes | length > 0

- name: Configure iptables DNAT rules for VIP
  ansible.builtin.iptables:
    table: nat
    chain: PREROUTING
    in_interface: "{{ keepalived_vip_interface }}"
    protocol: tcp
    destination: "{{ keepalived_vip }}"
    destination_port: "{{ keepalived_vip_port }}"
    jump: DNAT
    to_destination: "{{ keepalived_active_plane.wireguard_ip }}:{{ keepalived_active_plane.backend_port }}"
    comment: "DNAT VIP:[k8s-api-port] to {{ keepalived_active_plane.name }}:[haproxy-frontend-port]"
  when: keepalived_active_plane is defined

- name: Configure iptables MASQUERADE for DNAT
  ansible.builtin.iptables:
    table: nat
    chain: POSTROUTING
    destination: "{{ keepalived_active_plane.wireguard_ip }}"
    destination_port: "{{ keepalived_active_plane.backend_port }}"
    protocol: tcp
    jump: MASQUERADE
    comment: "MASQUERADE for VIP DNAT to {{ keepalived_active_plane.name }}"
  when: keepalived_active_plane is defined

- name: Save iptables rules (persist across reboots)
  ansible.builtin.shell:
    cmd: iptables-save > /etc/iptables/rules.v4
  args:
    creates: /etc/iptables/rules.v4
  when: ansible_facts['os_family'] == 'Debian'

- name: Configure UFW to allow VIP access
  community.general.ufw:
    rule: allow
    proto: tcp
    port: "{{ keepalived_vip_port }}"
    from: any
    direction: in
  when: ansible_facts['os_family'] == 'Debian'

- name: Configure UFW to allow WireGuard traffic
  community.general.ufw:
    rule: allow
    proto: udp
    port: "{{ vault_wg_server_port | default('51840') }}"
    from: any
    direction: in
  when: ansible_facts['os_family'] == 'Debian'

- name: Deploy keepalived configuration
  ansible.builtin.template:
    src: keepalived.conf.j2
    dest: /etc/keepalived/keepalived.conf
    mode: "0644"
    validate: "keepalived -t -f %s"
  notify: Restart keepalived

- name: Ensure keepalived is enabled and started
  ansible.builtin.systemd:
    name: keepalived
    state: started
    enabled: true

- name: Wait for VIP to be assigned
  ansible.builtin.wait_for:
    host: "{{ keepalived_vip }}"
    port: "{{ keepalived_vip_port }}"
    delay: 3
    timeout: 30

- name: Verify VIP is active
  ansible.builtin.command: ip addr show {{ keepalived_vip_interface }} | grep {{ keepalived_vip }}
  register: vip_check
  changed_when: false

- name: Assert VIP is active
  ansible.builtin.assert:
    that:
      - vip_check.rc == 0
    success_msg: "VIP {{ keepalived_vip }} is active on {{ keepalived_vip_interface }}"
    fail_msg: "VIP {{ keepalived_vip }} is NOT active"

- name: Test connectivity to VIP
  ansible.builtin.wait_for:
    host: "{{ keepalived_vip }}"
    port: "{{ keepalived_vip_port }}"
    timeout: 5

- name: Log VIP configuration
  ansible.builtin.debug:
    msg: |
      VIP Configuration:
      - VIP: {{ keepalived_vip }}/{{ keepalived_vip_cidr }}
      - Interface: {{ keepalived_vip_interface }}
      - Port: {{ keepalived_vip_port }}
      - Active Plane: {{ keepalived_active_plane.name | default('N/A') }}
      - DNAT: {{ keepalived_vip }}:{{ keepalived_vip_port }} â†’ {{ keepalived_active_plane.wireguard_ip | default('N/A') }}:{{ keepalived_active_plane.backend_port | default('N/A') }}
