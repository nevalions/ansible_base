---
# Keepalived role for Kubernetes API VIP management
# Simplified architecture: VIP floats between control planes, no HAProxy/DNAT needed
# Workers connect to VIP -> traffic goes directly to kube-apiserver on MASTER node

- name: Ensure keepalived is installed
  ansible.builtin.apt:
    name:
      - keepalived
      - curl
    state: present
    update_cache: true

- name: Determine whether keepalived should use unicast
  ansible.builtin.set_fact:
    keepalived_use_unicast: "{{ keepalived_unicast | default((keepalived_vip_interface | regex_search('^wg')) is not none) }}"

- name: Determine unicast source IP from control plane list
  ansible.builtin.set_fact:
    keepalived_unicast_src_ip: >-
      {{
        keepalived_unicast_src_ip
        | default(
            (
              ansible_facts.get(keepalived_vip_interface, {})
              .get('ipv4', {})
              .get('address', '')
            ),
            true
          )
        | default(
            (
              keepalived_control_planes
              | selectattr('name', 'in', [inventory_hostname, ansible_host | default('')])
              | map(attribute='wireguard_ip')
              | list
              | first
              | default('')
            ),
            true
          )
        | default(
            (
              keepalived_control_planes
              | selectattr('wireguard_ip', 'in', [inventory_hostname, ansible_host | default('')])
              | map(attribute='wireguard_ip')
              | list
              | first
              | default('')
            ),
            true
          )
      }}
  when: keepalived_use_unicast

- name: Assert unicast source IP is set when required
  ansible.builtin.assert:
    that:
      - keepalived_unicast_src_ip is defined
      - keepalived_unicast_src_ip | length > 0
    success_msg: "Keepalived unicast source IP is set: {{ keepalived_unicast_src_ip }}"
    fail_msg: "Keepalived unicast source IP is required for {{ keepalived_vip_interface }}. Set keepalived_unicast_src_ip."
  when: keepalived_use_unicast

- name: Assert keepalived control plane list is defined
  ansible.builtin.assert:
    that:
      - keepalived_control_planes is defined
      - keepalived_control_planes | length > 0
    success_msg: "Keepalived control planes list is defined"
    fail_msg: "vault_k8s_control_planes must be defined (at least one control plane entry)"

- name: Resolve keepalived priority and index for this host
  ansible.builtin.set_fact:
    keepalived_plane_index: >-
      {%- set wg_ip = ansible_facts.get(keepalived_vip_interface, {}).get('ipv4', {}).get('address', '') -%}
      {%- set match_names = [inventory_hostname, ansible_hostname | default(''), ansible_host | default('')]
                            | reject('equalto', '') | list -%}
      {%- set match_ips   = [wg_ip, ansible_host | default(''), inventory_hostname]
                            | reject('equalto', '') | list -%}
      {%- set ns = namespace(idx=0, found=false) -%}
      {%- for plane in keepalived_control_planes -%}
        {%- if not ns.found -%}
          {%- if plane.name in match_names or plane.wireguard_ip in match_ips -%}
            {%- set ns.idx = loop.index0 -%}
            {%- set ns.found = true -%}
          {%- endif -%}
        {%- endif -%}
      {%- endfor -%}
      {{ ns.idx }}
    keepalived_priority: >-
      {%- set wg_ip = ansible_facts.get(keepalived_vip_interface, {}).get('ipv4', {}).get('address', '') -%}
      {%- set match_names = [inventory_hostname, ansible_hostname | default(''), ansible_host | default('')]
                            | reject('equalto', '') | list -%}
      {%- set match_ips   = [wg_ip, ansible_host | default(''), inventory_hostname]
                            | reject('equalto', '') | list -%}
      {%- set by_name = keepalived_control_planes
                        | selectattr('name', 'in', match_names)
                        | map(attribute='priority') | list -%}
      {%- set by_ip   = keepalived_control_planes
                        | selectattr('wireguard_ip', 'in', match_ips)
                        | map(attribute='priority') | list -%}
      {%- set ns = namespace(idx=0, found=false) -%}
      {%- for plane in keepalived_control_planes -%}
        {%- if not ns.found -%}
          {%- if plane.name in match_names or plane.wireguard_ip in match_ips -%}
            {%- set ns.idx = loop.index0 -%}
            {%- set ns.found = true -%}
          {%- endif -%}
        {%- endif -%}
      {%- endfor -%}
      {%- if by_name | length > 0 -%}
        {{ by_name | first }}
      {%- elif by_ip | length > 0 -%}
        {{ by_ip | first }}
      {%- else -%}
        {{ 150 - (ns.idx | int) * 50 }}
      {%- endif -%}
  when: keepalived_control_planes is defined and keepalived_control_planes | length > 0

- name: Determine keepalived state for this host
  ansible.builtin.set_fact:
    keepalived_state: >-
      {{
        'MASTER'
        if (keepalived_control_planes | length == 1)
        else (
          'MASTER'
          if keepalived_priority | int
             == (keepalived_control_planes | map(attribute='priority') | list | max)
          else 'BACKUP'
        )
      }}
  when: keepalived_control_planes is defined and keepalived_control_planes | length > 0

- name: Check if UFW is installed
  ansible.builtin.stat:
    path: /usr/sbin/ufw
  register: ufw_installed

- name: Check if UFW is active
  ansible.builtin.command: ufw status
  register: ufw_status
  changed_when: false
  failed_when: false
  when: ufw_installed.stat.exists

- name: Set UFW active fact
  ansible.builtin.set_fact:
    ufw_is_active: "{{ ufw_installed.stat.exists and ufw_status.stdout is defined and 'Status: active' in ufw_status.stdout }}"

- name: Configure UFW to allow VRRP protocol (via iptables - UFW doesn't support proto 112)
  ansible.builtin.iptables:
    chain: INPUT
    protocol: vrrp
    source: "{{ keepalived_vrrp_allowed_network | default(vault_wg_network_cidr | default('[network-cidr]')) }}"
    jump: ACCEPT
    comment: "Allow VRRP for Keepalived"
  when:
    - ansible_facts['os_family'] == 'Debian'
    - not (keepalived_vip_interface | regex_search('^wg'))
  ignore_errors: true

- name: Configure UFW to allow Kubernetes API on VIP
  community.general.ufw:
    rule: allow
    proto: tcp
    port: "{{ keepalived_vip_port }}"
    from: "{{ keepalived_api_allowed_network | default(vault_wg_network_cidr | default('any')) }}"
    direction: in
  when:
    - ansible_facts['os_family'] == 'Debian'
    - ufw_is_active

# Determine if we have multiple control planes for VRRP
- name: Count unicast peers
  ansible.builtin.set_fact:
    keepalived_unicast_peers: >-
      {{ keepalived_control_planes 
         | rejectattr('wireguard_ip', 'equalto', keepalived_unicast_src_ip) 
         | list }}
  when:
    - keepalived_use_unicast
    - keepalived_control_planes is defined
    - keepalived_control_planes | length > 0

- name: Set single node mode
  ansible.builtin.set_fact:
    keepalived_single_node: "{{ (keepalived_unicast_peers | default([]) | length) == 0 }}"

- name: Check if Kubernetes API server is initialized
  ansible.builtin.stat:
    path: /etc/kubernetes/admin.conf
  register: keepalived_k8s_initialized

- name: Set fact for apiserver health tracking
  ansible.builtin.set_fact:
    keepalived_track_apiserver: "{{ keepalived_k8s_initialized.stat.exists and (keepalived_unicast_peers | default([]) | length) > 0 }}"

- name: Set WireGuard failover gateway SSH host
  ansible.builtin.set_fact:
    keepalived_wg_failover_owner_name: >-
      {{
        (
          keepalived_control_planes
          | selectattr('name', 'in', [inventory_hostname, ansible_hostname | default(''), ansible_host | default('')])
          | map(attribute='name')
          | list
          | first
          | default('')
        )
        or
        (
          keepalived_control_planes
          | selectattr('wireguard_ip', 'in', [
              ansible_facts.get(keepalived_vip_interface, {}).get('ipv4', {}).get('address', ''),
              ansible_host | default(''),
              inventory_hostname
            ])
          | map(attribute='name')
          | list
          | first
          | default('')
        )
        or inventory_hostname
      }}
    keepalived_wg_failover_gateway_ssh_host: >-
      {{
        hostvars.get(keepalived_wg_failover_gateway_host, {}).get('ansible_host', keepalived_wg_failover_gateway_host)
      }}
    keepalived_wg_failover_gateway_ssh_port: >-
      {{
        hostvars.get(keepalived_wg_failover_gateway_host, {}).get('ansible_port', keepalived_wg_failover_gateway_port)
      }}
  when:
    - keepalived_wg_failover_enabled | default(false)
    - keepalived_wg_failover_gateway_host | length > 0

- name: Ensure keepalived runtime directory exists for failover scripts
  ansible.builtin.file:
    path: /etc/keepalived
    state: directory
    owner: root
    group: root
    mode: "0755"
  when:
    - keepalived_wg_failover_enabled | default(false)
    - not ansible_check_mode

- name: Generate SSH key for keepalived VIP failover notifier
  ansible.builtin.command: >-
    ssh-keygen -t ed25519 -N ''
    -f {{ keepalived_wg_failover_ssh_key_path }}
    -C keepalived-wg-vip-failover-{{ inventory_hostname }}
  args:
    creates: "{{ keepalived_wg_failover_ssh_key_path }}"
  when:
    - keepalived_wg_failover_enabled | default(false)
    - not ansible_check_mode

- name: Ensure keepalived failover SSH private key permissions
  ansible.builtin.file:
    path: "{{ keepalived_wg_failover_ssh_key_path }}"
    owner: root
    group: root
    mode: "0600"
  when:
    - keepalived_wg_failover_enabled | default(false)
    - not ansible_check_mode

- name: Read keepalived failover SSH public key
  ansible.builtin.slurp:
    path: "{{ keepalived_wg_failover_ssh_key_path }}.pub"
  register: keepalived_failover_ssh_pubkey_raw
  when:
    - keepalived_wg_failover_enabled | default(false)
    - not ansible_check_mode

- name: Set keepalived failover SSH public key fact
  ansible.builtin.set_fact:
    keepalived_failover_ssh_pubkey: "{{ keepalived_failover_ssh_pubkey_raw.content | b64decode | trim }}"
  when:
    - keepalived_wg_failover_enabled | default(false)
    - not ansible_check_mode

- name: Ensure gateway .ssh directory exists
  ansible.builtin.file:
    path: "/home/{{ keepalived_wg_failover_gateway_user }}/.ssh"
    state: directory
    owner: "{{ keepalived_wg_failover_gateway_user }}"
    group: "{{ keepalived_wg_failover_gateway_user }}"
    mode: "0700"
  delegate_to: "{{ keepalived_wg_failover_gateway_host }}"
  become: true
  when:
    - keepalived_wg_failover_enabled | default(false)
    - keepalived_wg_failover_gateway_host | length > 0
    - not ansible_check_mode

- name: Allow control planes to trigger gateway VIP failover script
  ansible.builtin.lineinfile:
    path: "/home/{{ keepalived_wg_failover_gateway_user }}/.ssh/authorized_keys"
    create: true
    owner: "{{ keepalived_wg_failover_gateway_user }}"
    group: "{{ keepalived_wg_failover_gateway_user }}"
    mode: "0600"
    line: "{{ keepalived_failover_ssh_pubkey }}"
    state: present
  delegate_to: "{{ keepalived_wg_failover_gateway_host }}"
  become: true
  when:
    - keepalived_wg_failover_enabled | default(false)
    - keepalived_wg_failover_gateway_host | length > 0
    - not ansible_check_mode

- name: Deploy gateway WireGuard API VIP failover helper script
  ansible.builtin.template:
    src: wg-api-vip-failover.sh.j2
    dest: "{{ keepalived_wg_failover_gateway_script_path }}"
    owner: root
    group: root
    mode: "0750"
  delegate_to: "{{ keepalived_wg_failover_gateway_host }}"
  become: true
  when:
    - keepalived_wg_failover_enabled | default(false)
    - keepalived_wg_failover_gateway_host | length > 0
    - not ansible_check_mode

- name: Allow gateway user to run WireGuard failover helper without password
  ansible.builtin.copy:
    dest: /etc/sudoers.d/keepalived_wg_vip_failover
    owner: root
    group: root
    mode: "0440"
    content: |
      {{ keepalived_wg_failover_gateway_user }} ALL=(root) NOPASSWD: {{ keepalived_wg_failover_gateway_script_path }} *
    validate: /usr/sbin/visudo -cf %s
  delegate_to: "{{ keepalived_wg_failover_gateway_host }}"
  become: true
  when:
    - keepalived_wg_failover_enabled | default(false)
    - keepalived_wg_failover_gateway_host | length > 0
    - not ansible_check_mode

- name: Deploy keepalived notify script for WireGuard VIP failover
  ansible.builtin.template:
    src: wg-api-vip-notify.sh.j2
    dest: /usr/local/sbin/wg-api-vip-notify.sh
    owner: root
    group: root
    mode: "0755"
  when:
    - keepalived_wg_failover_enabled | default(false)
    - not ansible_check_mode

# Deploy Keepalived configuration (single node uses unicast-to-self on wg*)
- name: Deploy keepalived configuration
  ansible.builtin.template:
    src: keepalived.conf.j2
    dest: /etc/keepalived/keepalived.conf
    mode: "0644"
    validate: "keepalived -t -f %s"
  notify: Restart keepalived

- name: Remove legacy VIP persistence file (VIP managed by keepalived)
  ansible.builtin.file:
    path: /etc/network/interfaces.d/{{ keepalived_vip_interface }}-vip
    state: absent
  failed_when: false
  when: not ansible_check_mode

- name: Ensure keepalived is enabled and started
  ansible.builtin.systemd:
    name: keepalived
    state: started
    enabled: true
  when:
    - not ansible_check_mode

- name: Wait for VIP to stabilize
  ansible.builtin.pause:
    seconds: 2
  when: not ansible_check_mode

- name: Verify VIP is active on this host
  ansible.builtin.shell: ip addr show {{ keepalived_vip_interface }} | grep -q {{ keepalived_vip }}
  register: vip_check
  changed_when: false
  failed_when: false
  when: not ansible_check_mode

- name: Report VIP status
  ansible.builtin.debug:
    msg: "VIP {{ keepalived_vip }} on {{ keepalived_vip_interface }}: {{ 'ACTIVE (this is MASTER)' if vip_check.rc == 0 else 'INACTIVE (this is BACKUP)' }}"
  when: not ansible_check_mode

- name: Assert VIP is active on MASTER node
  ansible.builtin.assert:
    that:
      - vip_check.rc == 0
    success_msg: "VIP {{ keepalived_vip }} is active on {{ keepalived_vip_interface }} (MASTER)"
    fail_msg: "VIP {{ keepalived_vip }} is NOT active - expected on MASTER node"
  when:
    - not ansible_check_mode
    - keepalived_state == 'MASTER'

- name: Log VIP configuration summary
  ansible.builtin.debug:
    msg: |
      Keepalived Configuration:
      - VIP: {{ keepalived_vip }}/{{ keepalived_vip_cidr }}
      - Interface: {{ keepalived_vip_interface }}
      - API Port: {{ keepalived_vip_port }}
      - Mode: {{ 'Single Node (Keepalived)' if keepalived_single_node else 'Multi-Node (VRRP)' }}
      - State: {{ keepalived_state }}
      - Priority: {{ keepalived_priority }}
      - Unicast Peers: {{ keepalived_unicast_peers | default([]) | map(attribute='wireguard_ip') | list | join(', ') | default('None') }}
      - Control Planes: {{ keepalived_control_planes | map(attribute='name') | list | join(', ') }}
  when: not ansible_check_mode
