---
- name: Ensure keepalived is installed
  ansible.builtin.apt:
    name:
      - keepalived
      - iptables-persistent
    state: present
    update_cache: true

- name: Determine whether keepalived should use unicast
  ansible.builtin.set_fact:
    keepalived_use_unicast: "{{ keepalived_unicast | default((keepalived_vip_interface | regex_search('^wg')) is not none) }}"

- name: Determine unicast source IP from control plane list
  ansible.builtin.set_fact:
    keepalived_unicast_src_ip: >-
      {{
        keepalived_unicast_src_ip
        | default(
            (
              ansible_facts.get(keepalived_vip_interface, {})
              .get('ipv4', {})
              .get('address', '')
            ),
            true
          )
        | default(
            (
              keepalived_control_planes
              | selectattr('name', 'in', [inventory_hostname, ansible_host | default('')])
              | map(attribute='wireguard_ip')
              | list
              | first
              | default('')
            ),
            true
          )
        | default(
            (
              keepalived_control_planes
              | selectattr('wireguard_ip', 'in', [inventory_hostname, ansible_host | default('')])
              | map(attribute='wireguard_ip')
              | list
              | first
              | default('')
            ),
            true
          )
      }}
  when: keepalived_use_unicast

- name: Assert unicast source IP is set when required
  ansible.builtin.assert:
    that:
      - keepalived_unicast_src_ip is defined
      - keepalived_unicast_src_ip | length > 0
    success_msg: "Keepalived unicast source IP is set"
    fail_msg: "Keepalived unicast source IP is required for {{ keepalived_vip_interface }}. Set keepalived_unicast_src_ip."
  when: keepalived_use_unicast

- name: Determine active control plane (for iptables DNAT)
  ansible.builtin.set_fact:
    keepalived_active_plane: "{{ keepalived_control_planes[0] }}"
  when: keepalived_control_planes is defined and keepalived_control_planes | length > 0

- name: Determine keepalived priority for this host
  ansible.builtin.set_fact:
    keepalived_priority: >-
      {{
        keepalived_priority
        | default(
            (
              keepalived_control_planes
              | selectattr('name', 'in', [inventory_hostname, ansible_host | default('')])
              | map(attribute='priority')
              | list
              | first
              | default('')
            ),
            true
          )
        | default(
            (
              keepalived_control_planes
              | selectattr('wireguard_ip', 'in', [inventory_hostname, ansible_host | default('')])
              | map(attribute='priority')
              | list
              | first
              | default('')
            ),
            true
          )
        | default(100, true)
      }}
  when: keepalived_control_planes is defined and keepalived_control_planes | length > 0

- name: Configure iptables DNAT rules for VIP
  ansible.builtin.iptables:
    table: nat
    chain: PREROUTING
    in_interface: "{{ keepalived_vip_interface }}"
    protocol: tcp
    destination: "{{ keepalived_vip }}"
    destination_port: "{{ keepalived_vip_port }}"
    jump: DNAT
    to_destination: "{{ keepalived_active_plane.wireguard_ip }}:{{ keepalived_active_plane.backend_port }}"
    comment: "DNAT VIP:[k8s-api-port] to {{ keepalived_active_plane.name }}:[haproxy-frontend-port]"
  when: keepalived_active_plane is defined

- name: Configure iptables MASQUERADE for DNAT
  ansible.builtin.iptables:
    table: nat
    chain: POSTROUTING
    destination: "{{ keepalived_active_plane.wireguard_ip }}"
    destination_port: "{{ keepalived_active_plane.backend_port }}"
    protocol: tcp
    jump: MASQUERADE
    comment: "MASQUERADE for VIP DNAT to {{ keepalived_active_plane.name }}"
  when: keepalived_active_plane is defined

- name: Save iptables rules (persist across reboots)
  ansible.builtin.shell:
    cmd: iptables-save > /etc/iptables/rules.v4
  args:
    creates: /etc/iptables/rules.v4
  when: ansible_facts['os_family'] == 'Debian'

- name: Ensure UFW is installed
  ansible.builtin.apt:
    name: ufw
    state: present
    update_cache: true
  when: ansible_facts['os_family'] == 'Debian'

- name: Configure UFW to allow VIP access
  community.general.ufw:
    rule: allow
    proto: tcp
    port: "{{ keepalived_vip_port }}"
    from: any
    direction: in
  when: ansible_facts['os_family'] == 'Debian'

- name: Configure UFW to allow WireGuard traffic
  community.general.ufw:
    rule: allow
    proto: udp
    port: "{{ vault_wg_server_port | default('51840') }}"
    from: any
    direction: in
  when: ansible_facts['os_family'] == 'Debian'

- name: Deploy keepalived configuration
  ansible.builtin.template:
    src: keepalived.conf.j2
    dest: /etc/keepalived/keepalived.conf
    mode: "0644"
    validate: "keepalived -t -f %s"
  notify: Restart keepalived

- name: Ensure keepalived is enabled and started
  ansible.builtin.systemd:
    name: keepalived
    state: started
    enabled: true
  when: not ansible_check_mode

- name: Wait for VIP to be assigned
  ansible.builtin.wait_for:
    host: "{{ keepalived_vip }}"
    port: "{{ keepalived_vip_port }}"
    delay: 3
    timeout: 30
  when:
    - not ansible_check_mode
    - keepalived_wait_for_port | default(false)

- name: Verify VIP is active
  ansible.builtin.shell: ip addr show {{ keepalived_vip_interface }} | grep {{ keepalived_vip }}
  register: vip_check
  changed_when: false
  when: not ansible_check_mode

- name: Assert VIP is active
  ansible.builtin.assert:
    that:
      - vip_check.rc == 0
    success_msg: "VIP {{ keepalived_vip }} is active on {{ keepalived_vip_interface }}"
    fail_msg: "VIP {{ keepalived_vip }} is NOT active"
  when: not ansible_check_mode

- name: Test connectivity to VIP
  ansible.builtin.wait_for:
    host: "{{ keepalived_vip }}"
    port: "{{ keepalived_vip_port }}"
    timeout: 5
  when:
    - not ansible_check_mode
    - keepalived_wait_for_port | default(false)

- name: Log VIP configuration
  ansible.builtin.debug:
    msg: |
      VIP Configuration:
      - VIP: {{ keepalived_vip }}/{{ keepalived_vip_cidr }}
      - Interface: {{ keepalived_vip_interface }}
      - Port: {{ keepalived_vip_port }}
      - Active Plane: {{ keepalived_active_plane.name | default('N/A') }}
      - DNAT: {{ keepalived_vip }}:{{ keepalived_vip_port }} â†’ {{ keepalived_active_plane.wireguard_ip | default('N/A') }}:{{ keepalived_active_plane.backend_port | default('N/A') }}
  when: not ansible_check_mode
