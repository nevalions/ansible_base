# Keepalived Configuration for Kubernetes API VIP
# Managed by Ansible - DO NOT EDIT MANUALLY

global_defs {
    router_id {{ keepalived_router_id }}
    vrrp_garp_master_delay 1
    vrrp_garp_master_repeat 5
    vrrp_garp_master_refresh 600
    vrrp_garp_interval 0
    vrrp_gna_interval 0
}

# Health check script for HAProxy on control planes
{% for plane in keepalived_control_planes %}
vrrp_script haproxy_check_{{ plane.name }} {
    script "/bin/bash -c 'timeout 2 /usr/bin/nc -z {{ plane.wireguard_ip }} {{ plane.backend_port }}'"
    interval {{ keepalived_check_interval }}
    rise {{ keepalived_check_rise }}
    fall {{ keepalived_check_fall }}
    weight 20
}

# Health check script for Kubernetes API on control planes
vrrp_script k8s_api_check_{{ plane.name }} {
    script "/bin/bash -c 'timeout 2 /usr/bin/nc -z {{ plane.wireguard_ip }} {{ plane.api_port }}'"
    interval {{ keepalived_check_interval }}
    rise {{ keepalived_check_rise }}
    fall {{ keepalived_check_fall }}
    weight 10
}
{% endfor %}

# VRRP instance for Kubernetes API VIP
vrrp_instance k8s_api {
    interface {{ keepalived_vip_interface }}
    virtual_router_id {{ keepalived_router_id }}
    priority 100
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass {{ keepalived_password }}
    }
    
    virtual_ipaddress {
        {{ keepalived_vip }}/{{ keepalived_vip_cidr }}
    }
    
    # Track health checks for all control planes
    {% for plane in keepalived_control_planes %}
    track_script {
        haproxy_check_{{ plane.name }}
        k8s_api_check_{{ plane.name }}
    }
    {% endfor %}
}
