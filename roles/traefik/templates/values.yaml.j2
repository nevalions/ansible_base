---
# Traefik Helm values managed by Ansible

deployment:
  kind: {{ traefik_deployment_kind | default('Deployment') }}
  replicas: {{ traefik_replica_count }}

podDisruptionBudget:
  enabled: true
  minAvailable: 1

service:
  enabled: true
  type: LoadBalancer
{% if traefik_metallb_address_pool_name | default('') | length > 0 %}
  annotations:
    # Support both legacy and current MetalLB annotation keys.
    metallb.universe.tf/address-pool: "{{ traefik_metallb_address_pool_name }}"
    metallb.io/address-pool: "{{ traefik_metallb_address_pool_name }}"
{% endif %}
  spec:
{% if traefik_load_balancer_ip | default('') | length > 0 %}
    loadBalancerIP: "{{ traefik_load_balancer_ip }}"
{% endif %}
    externalTrafficPolicy: {{ traefik_external_traffic_policy }}

ingressClass:
  enabled: {{ traefik_ingress_class_enabled | bool | lower }}
  isDefaultClass: {{ traefik_ingress_class_is_default | bool | lower }}

ingressRoute:
  dashboard:
    enabled: {{ traefik_dashboard_enabled | bool | lower }}

{% if traefik_persistence_enabled | default(false) | bool %}
persistence:
  enabled: true
{%   if traefik_persistence_existing_claim | default('') | length > 0 %}
  existingClaim: "{{ traefik_persistence_existing_claim }}"
{%   else %}
  accessMode: "{{ traefik_persistence_access_mode | default('ReadWriteOnce') }}"
  size: "{{ traefik_persistence_size | default('1Gi') }}"
{%     if traefik_persistence_storage_class | default('') | length > 0 %}
  storageClass: "{{ traefik_persistence_storage_class }}"
{%     endif %}
{%   endif %}
{% endif %}

ports:
  web:
    expose:
      default: true
    exposedPort: 80
{% if traefik_http_redirect_to_https | bool %}
    http:
      redirections:
        entryPoint:
          to: websecure
          scheme: https
          permanent: true
{% endif %}
{% if traefik_proxy_protocol_enabled | default(false) | bool and traefik_proxy_protocol_trusted_ips | default([]) | length > 0 %}
    proxyProtocol:
      trustedIPs:
{% for ip in traefik_proxy_protocol_trusted_ips %}
        - "{{ ip }}"
{% endfor %}
    forwardedHeaders:
      trustedIPs:
{% for ip in traefik_proxy_protocol_trusted_ips %}
        - "{{ ip }}"
{% endfor %}
{% endif %}
  websecure:
    expose:
      default: true
    exposedPort: 443
    http:
      tls:
        enabled: {{ traefik_tls_enabled | bool | lower }}
{% if traefik_certresolver_enabled | bool %}
        certResolver: {{ traefik_certresolver_name | default('letsencrypt') }}
{% endif %}
{% if traefik_proxy_protocol_enabled | default(false) | bool and traefik_proxy_protocol_trusted_ips | default([]) | length > 0 %}
    proxyProtocol:
      trustedIPs:
{% for ip in traefik_proxy_protocol_trusted_ips %}
        - "{{ ip }}"
{% endfor %}
    forwardedHeaders:
      trustedIPs:
{% for ip in traefik_proxy_protocol_trusted_ips %}
        - "{{ ip }}"
{% endfor %}
{% endif %}

{% if traefik_certresolver_enabled | bool %}
certificatesResolvers:
  {{ traefik_certresolver_name | default('letsencrypt') }}:
    acme:
      email: {{ traefik_acme_email }}
      storage: {{ traefik_acme_storage | default('/data/acme.json') }}
      httpChallenge:
        entryPoint: {{ traefik_acme_httpchallenge_entrypoint | default('web') }}
{% endif %}
