---
# Install Kubernetes binaries on all cluster nodes (planes + workers)
# Usage:
#   ansible-playbook kuber.yaml                    # All nodes
#   ansible-playbook kuber.yaml -l planes_all     # Only control planes
#   ansible-playbook kuber.yaml -l workers_all    # Only workers
#   ansible-playbook kuber.yaml -l [worker-hostname]  # Specific node
- name: Setup Kubernetes Cluster
  hosts: kuber_small_all
  become: true
  gather_facts: true
  serial: 1
  tags:
    - kubernetes
    - k8s
    - install
    - cluster
  vars_files:
    - vault_secrets.yml
  vars:
    common: false
    zsh: false
    dotfiles: false
    kuber: true
  tasks:
    - name: Check if nfs-common is installed before
      ansible.builtin.shell: dpkg -l | grep nfs-common
      register: nfs_pre_check
      changed_when: false
      failed_when: false

    - name: Display nfs-common status before installation
      ansible.builtin.debug:
        msg: "nfs-common installed: {{ 'Yes' if nfs_pre_check.rc == 0 else 'No' }}"

    - name: Install nfs-common for Kubernetes storage
      ansible.builtin.apt:
        name: nfs-common
        state: present
        update_cache: yes

    - name: Verify nfs-common is installed after
      ansible.builtin.shell: dpkg -l | grep nfs-common
      register: nfs_post_check
      changed_when: false

    - name: Verify nfs-common installation
      ansible.builtin.assert:
        that:
          - nfs_post_check.rc == 0
        success_msg: "nfs-common successfully installed"
        fail_msg: "nfs-common installation failed"

    - name: Display nfs-common status after installation
      ansible.builtin.debug:
        msg: "nfs-common installed: Yes"
  roles:
    - setup
