- name: Install NFS server packages
  apt:
    name: nfs-kernel-server
    state: present

- name: Check if folders exist
  stat:
    path: "{{ item.path }}"
  loop: "{{ nfs_exports }}"
  register: folder_check
  ignore_errors: yes

- name: Fail if any folders exist
  fail:
    msg: "ERROR: The folder '{{ item.item.path }}' already exists. Please remove it or choose a different path."
  when: item.stat.exists
  loop: "{{ folder_check.results }}"
  run_once: true

- name: Create NFS export directories
  file:
    path: "{{ item.item.path }}"
    state: directory
    mode: "0777"
    owner: nobody
    group: nogroup
    recurse: yes
  loop: "{{ folder_check.results }}"
  when: not item.stat.exists

- name: Check if folders created
  stat:
    path: "{{ item.path }}"
  loop: "{{ nfs_exports }}"
  register: folder_created
  ignore_errors: yes

- name: Fail if any folder not created
  fail:
    msg: "Folder '{{ item.path }}' not created - stopping execution"
  when: not item.stat.exists
  loop: "{{ folder_created.results }}"
  ignore_errors: no

- name: Check if export already exists in /etc/exports
  find:
    paths: /etc
    patterns: exports
    contains: "{{ item.path }} {{ item.clients }}({{ item.options }})"
  register: check_exports
  loop: "{{ nfs_exports }}"
  changed_when: false

- name: Configure NFS exports (add new exports)
  lineinfile:
    path: /etc/exports
    line: "{{ item.0.path }} {{ item.0.clients }}({{ item.0.options }})"
    state: present
    create: true
  loop: "{{ nfs_exports | zip(check_exports.results) | list }}"
  when: not item.1.matched
  notify: restart nfs

- name: Ensure ufw is installed
  apt:
    name: ufw
    state: present
  when: ansible_os_family == 'Debian'

- name: Allow NFS through firewall
  ufw:
    rule: allow
    proto: tcp
    port: "2049"
    src: "{{ item.clients }}"
  loop: "{{ nfs_exports }}"
  when: ansible_os_family == 'Debian'

- name: Check if NFS exports are correctly added
  command: grep -q "{{ item.path }} {{ item.clients }}({{ item.options }})" /etc/exports
  loop: "{{ nfs_exports }}"
  register: check_exports_final
  failed_when: check_exports_final.rc != 0
  changed_when: false
