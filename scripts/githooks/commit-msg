#!/bin/bash
# Git commit-msg hook to validate commit messages
# Ensures commit messages follow proper format and don't contain sensitive data

set -e

# ANSI color codes
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Get commit message file path
COMMIT_MSG_FILE="$1"

# Read commit message
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Remove comments from message (lines starting with #)
COMMIT_MSG=$(echo "$COMMIT_MSG" | sed '/^#/d')

# Remove leading/trailing whitespace
COMMIT_MSG=$(echo "$COMMIT_MSG" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')

# Check if message is empty
if [ -z "$COMMIT_MSG" ]; then
    echo -e "${RED}✗ Error: Commit message is empty${NC}"
    echo -e "${YELLOW}Please provide a descriptive commit message${NC}"
    exit 1
fi

# Check minimum length
if [ ${#COMMIT_MSG} -lt 10 ]; then
    echo -e "${RED}✗ Error: Commit message is too short (minimum 10 characters)${NC}"
    echo -e "${YELLOW}Current length: ${#COMMIT_MSG} characters${NC}"
    exit 1
fi

# Check commit message format (Conventional Commits)
# Format: type(scope): description
# Types: feat, fix, docs, refactor, test, chore, style, perf, ci, build
if ! echo "$COMMIT_MSG" | grep -qE '^(feat|fix|docs|refactor|test|chore|style|perf|ci|build|revert)(\(.+\))?: .{10,}'; then
    echo -e "${YELLOW}⚠ Warning: Commit message doesn't follow Conventional Commits format${NC}"
    echo -e "${YELLOW}Recommended format: type(scope): description${NC}"
    echo -e "${YELLOW}Examples:${NC}"
    echo -e "  ${YELLOW}feat(auth): add login functionality${NC}"
    echo -e "  ${YELLOW}fix(api): resolve timeout issue${NC}"
    echo -e "  ${YELLOW}docs(readme): update installation instructions${NC}"
    echo ""
    # Don't block, just warn
fi

# Check for sensitive data in commit message
SENSITIVE_PATTERNS=(
    '9\.11\.0\.'
    '192\.168\.'
    '10\.'
    '172\.'
    'haproxy_spb'
    'bay_bgp'
    'bay_plane'
    'cloud_'
)

for pattern in "${SENSITIVE_PATTERNS[@]}"; do
    if echo "$COMMIT_MSG" | grep -qE "$pattern"; then
        echo -e "${RED}✗ Error: Commit message contains sensitive data${NC}"
        echo -e "${RED}Found pattern: $pattern${NC}"
        echo -e "${YELLOW}Please remove sensitive data from commit message${NC}"
        echo -e "${YELLOW}Use placeholder patterns like [server-ip] instead${NC}"
        exit 1
    fi
done

# Check for placeholder patterns (encourage good practices)
if ! echo "$COMMIT_MSG" | grep -qE '\[[a-z-]+\]'; then
    # Only suggest placeholders if message contains IP-related words
    if echo "$COMMIT_MSG" | grep -qiE 'ip|address|port|host|server'; then
        echo -e "${YELLOW}⚠ Tip: Consider using placeholder patterns like [server-ip], [port], etc.${NC}"
    fi
fi

echo -e "${GREEN}✓ Commit message validation passed${NC}"
exit 0
