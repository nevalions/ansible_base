---
# Master playbook: Reset entire Kubernetes cluster
#
# This playbook resets the Kubernetes cluster in the correct order:
# 1. Workers first (to leave cluster gracefully)
# 2. Control plane last
#
# Usage:
#   # Full reset (remove packages)
#   ansible-playbook -i hosts_bay.ini kuber_cluster_reset.yaml
#
#   # Soft reset (keep packages, just reset cluster state)
#   ansible-playbook -i hosts_bay.ini kuber_cluster_reset.yaml -e reset_mode=soft
#
#   # Reset with MetalLB cleanup
#   ansible-playbook -i hosts_bay.ini kuber_cluster_reset.yaml -e cleanup_metallb=true
#
#   # Reset with BGP router cleanup
#   ansible-playbook -i hosts_bay.ini kuber_cluster_reset.yaml -e cleanup_bgp=true
#
#   # Full cleanup (MetalLB + BGP + Kubernetes)
#   ansible-playbook -i hosts_bay.ini kuber_cluster_reset.yaml -e cleanup_metallb=true -e cleanup_bgp=true

# Step 1: Remove MetalLB (optional)
- name: "Reset Step 1/4: Remove MetalLB"
  import_playbook: kuber_metallb_remove.yaml
  when: cleanup_metallb | default(false) | bool
  tags:
    - metallb
    - cleanup

# Step 2: Remove BGP router config (optional)
- name: "Reset Step 2/4: Remove BGP router configuration"
  import_playbook: bgp_router_remove.yaml
  when: cleanup_bgp | default(false) | bool
  tags:
    - bgp
    - cleanup

# Step 3: Reset workers first (they need to leave cluster before control plane goes down)
- name: "Reset Step 3/4: Reset Kubernetes workers"
  import_playbook: "{{ 'kuber_worker_soft_reset.yaml' if (reset_mode | default('full')) == 'soft' else 'kuber_worker_reset.yaml' }}"
  tags:
    - kubernetes
    - workers
    - reset

# Step 4: Reset control plane last
- name: "Reset Step 4/4: Reset Kubernetes control plane"
  import_playbook: "{{ 'kuber_plane_soft_reset.yaml' if (reset_mode | default('full')) == 'soft' else 'kuber_plane_reset.yaml' }}"
  tags:
    - kubernetes
    - plane
    - reset
