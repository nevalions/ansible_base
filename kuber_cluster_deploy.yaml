---
# Master playbook: Deploy entire Kubernetes cluster from scratch
#
# This playbook deploys the complete Kubernetes cluster stack:
# Phase 1: Infrastructure (DNS, WireGuard)
# Phase 2: Kubernetes prerequisites (packages, Keepalived)
# Phase 3: Kubernetes cluster (control plane, workers)
# Phase 4: LoadBalancer (Calico BGP, BGP router, MetalLB)
#
# Usage:
#   # Full deployment (all phases)
#   ansible-playbook -i hosts_bay.ini kuber_cluster_deploy.yaml
#
#   # Skip infrastructure (DNS/WireGuard already deployed)
#   ansible-playbook -i hosts_bay.ini kuber_cluster_deploy.yaml -e skip_infrastructure=true
#
#   # Skip MetalLB/BGP (no LoadBalancer needed)
#   ansible-playbook -i hosts_bay.ini kuber_cluster_deploy.yaml -e skip_metallb=true
#
#   # Skip Helm installation
#   ansible-playbook -i hosts_bay.ini kuber_cluster_deploy.yaml -e skip_helm=true
#
#   # Skip Traefik ingress controller
#   ansible-playbook -i hosts_bay.ini kuber_cluster_deploy.yaml -e skip_traefik=true
#
#   # Skip cert-manager and ClusterIssuer
#   ansible-playbook -i hosts_bay.ini kuber_cluster_deploy.yaml -e skip_cert_manager=true
#
#   # Kubernetes only (skip infra and metallb)
#   ansible-playbook -i hosts_bay.ini kuber_cluster_deploy.yaml -e skip_infrastructure=true -e skip_metallb=true
#
#   # Run specific phase only
#   ansible-playbook -i hosts_bay.ini kuber_cluster_deploy.yaml --tags phase1
#   ansible-playbook -i hosts_bay.ini kuber_cluster_deploy.yaml --tags phase2
#   ansible-playbook -i hosts_bay.ini kuber_cluster_deploy.yaml --tags phase3
#   ansible-playbook -i hosts_bay.ini kuber_cluster_deploy.yaml --tags phase4

###############################################################################
# PHASE 1: Infrastructure Setup
###############################################################################

# Step 1.1: Deploy DNS servers
- name: "Phase 1.1: Deploy DNS servers"
  import_playbook: dns_server_manage.yaml
  when: not (skip_infrastructure | default(false) | bool)
  tags:
    - phase1
    - infrastructure
    - dns

# Step 1.2: Deploy WireGuard VPN
- name: "Phase 1.2: Deploy WireGuard VPN"
  import_playbook: wireguard_manage.yaml
  when: not (skip_infrastructure | default(false) | bool)
  tags:
    - phase1
    - infrastructure
    - wireguard

# Step 1.3: Verify WireGuard connectivity
- name: "Phase 1.3: Verify WireGuard connectivity"
  import_playbook: wireguard_verify.yaml
  when: not (skip_infrastructure | default(false) | bool)
  tags:
    - phase1
    - infrastructure
    - wireguard
    - verify

# Step 1.4: Configure DNS clients
- name: "Phase 1.4: Configure DNS clients"
  import_playbook: dns_client_manage.yaml
  when: not (skip_infrastructure | default(false) | bool)
  tags:
    - phase1
    - infrastructure
    - dns

# Step 1.5: Verify DNS
- name: "Phase 1.5: Verify DNS resolution"
  import_playbook: dns_verify.yaml
  when: not (skip_infrastructure | default(false) | bool)
  tags:
    - phase1
    - infrastructure
    - dns
    - verify

###############################################################################
# PHASE 2: Kubernetes Prerequisites
###############################################################################

# Step 2.1: Install Kubernetes packages
- name: "Phase 2.1: Install Kubernetes packages"
  import_playbook: kuber.yaml
  tags:
    - phase2
    - kubernetes
    - packages

# Step 2.2: Configure Keepalived VIP
- name: "Phase 2.2: Configure Keepalived VIP"
  import_playbook: keepalived_manage.yaml
  tags:
    - phase2
    - kubernetes
    - keepalived

###############################################################################
# PHASE 3: Kubernetes Cluster
###############################################################################

# Step 3.1: Initialize control plane
- name: "Phase 3.1: Initialize Kubernetes control plane"
  import_playbook: kuber_plane_init.yaml
  tags:
    - phase3
    - kubernetes
    - init
    - plane

# Step 3.2: Join worker nodes
- name: "Phase 3.2: Join Kubernetes worker nodes"
  import_playbook: kuber_worker_join.yaml
  tags:
    - phase3
    - kubernetes
    - join
    - workers

# Step 3.3: Verify cluster health
- name: "Phase 3.3: Verify Kubernetes cluster health"
  import_playbook: kuber_verify.yaml
  tags:
    - phase3
    - kubernetes
    - verify

# Step 3.4: Install Helm (cluster client tooling)
- name: "Phase 3.4: Install Helm"
  import_playbook: kuber_helm_install.yaml
  when: not (skip_helm | default(false) | bool)
  tags:
    - phase3
    - kubernetes
    - helm
    - addon

# Step 3.5: Verify Helm
- name: "Phase 3.5: Verify Helm"
  import_playbook: kuber_helm_verify.yaml
  when: not (skip_helm | default(false) | bool)
  tags:
    - phase3
    - kubernetes
    - helm
    - verify

###############################################################################
# PHASE 4: LoadBalancer (MetalLB with BGP)
###############################################################################

# Step 4.1: Configure Calico BGP port
- name: "Phase 4.1: Configure Calico BGP port"
  import_playbook: calico_bgp_manage.yaml
  when: not (skip_metallb | default(false) | bool)
  tags:
    - phase4
    - metallb
    - calico
    - bgp

# Step 4.2: Deploy BGP HA (FRR + Keepalived)
- name: "Phase 4.2: Deploy BGP HA (FRR + Keepalived)"
  import_playbook: bgp_ha_deploy.yaml
  when: not (skip_metallb | default(false) | bool)
  tags:
    - phase4
    - metallb
    - bgp
    - bgp_ha

# Step 4.3: Install MetalLB
- name: "Phase 4.3: Install and configure MetalLB"
  import_playbook: kuber_metallb_install.yaml
  when: not (skip_metallb | default(false) | bool)
  tags:
    - phase4
    - metallb

# Step 4.4: Verify BGP HA
- name: "Phase 4.4: Verify BGP HA (FRR + Keepalived)"
  import_playbook: bgp_ha_verify.yaml
  when: not (skip_metallb | default(false) | bool)
  tags:
    - phase4
    - metallb
    - bgp
    - bgp_ha
    - verify

# Step 4.5: Verify MetalLB
- name: "Phase 4.5: Verify MetalLB"
  import_playbook: kuber_metallb_verify.yaml
  when: not (skip_metallb | default(false) | bool)
  tags:
    - phase4
    - metallb
    - verify

###############################################################################
# PHASE 5: Ingress Controller (Traefik)
###############################################################################

# Step 5.1: Install Traefik
- name: "Phase 5.1: Install Traefik ingress controller"
  import_playbook: kuber_traefik_install.yaml
  when:
    - not (skip_traefik | default(false) | bool)
    - not (skip_metallb | default(false) | bool)
  tags:
    - phase5
    - traefik
    - ingress

# Step 5.2: Verify Traefik
- name: "Phase 5.2: Verify Traefik ingress controller"
  import_playbook: kuber_traefik_verify.yaml
  when:
    - not (skip_traefik | default(false) | bool)
    - not (skip_metallb | default(false) | bool)
  tags:
    - phase5
    - traefik
    - ingress
    - verify

###############################################################################
# PHASE 6: TLS (cert-manager)
###############################################################################

# Step 6.1: Install cert-manager + Let's Encrypt staging ClusterIssuer
- name: "Phase 6.1: Install cert-manager"
  import_playbook: kuber_cert_manager_install.yaml
  when: not (skip_cert_manager | default(false) | bool)
  tags:
    - phase6
    - cert_manager
    - tls

# Step 6.2: Verify cert-manager
- name: "Phase 6.2: Verify cert-manager"
  import_playbook: kuber_cert_manager_verify.yaml
  when: not (skip_cert_manager | default(false) | bool)
  tags:
    - phase6
    - cert_manager
    - tls
    - verify
